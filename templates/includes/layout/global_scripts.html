{% load static %}
<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.7.0.min.js" defer></script>
<!-- International Phone Input JS -->
<script src="https://cdn.jsdelivr.net/npm/intl-tel-input@18.2.1/build/js/intlTelInput.min.js" defer></script>
<!-- Custom Phone Input Manager -->
<script src="{% static 'js/phone-input.js' %}" defer></script>

<!-- Mobile Menu Script -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const mobileMenuButton = document.getElementById('mobile-menu-button');
        const mobileMenu = document.getElementById('mobile-menu');
        const mobileDropdownEntries = [];
        const dropdownEntryMap = {};

        const hideDropdownEntry = (entry) => {
            entry.dropdown.classList.add('hidden');
            entry.button.setAttribute('aria-expanded', 'false');
        };

        const closeOtherDropdowns = (currentId) => {
            mobileDropdownEntries.forEach(entry => {
                if (entry.dropdown.id !== currentId) {
                    hideDropdownEntry(entry);
                }
            });
        };

        const hideDropdownById = (dropdownId) => {
            if (!dropdownId) {
                return;
            }
            const entry = dropdownEntryMap[dropdownId];
            if (entry) {
                hideDropdownEntry(entry);
            } else {
                const fallback = document.getElementById(dropdownId);
                if (fallback) {
                    fallback.classList.add('hidden');
                }
            }
        };

        window.hideMobileDropdownById = hideDropdownById;
        window.closeAllMobileDropdowns = () => {
            mobileDropdownEntries.forEach(entry => hideDropdownEntry(entry));
        };

        const mobileDropdownToggles = document.querySelectorAll('[data-mobile-dropdown-toggle]');
        mobileDropdownToggles.forEach(button => {
            const targetId = button.dataset.mobileDropdownToggle;
            if (!targetId) {
                return;
            }
            const dropdown = document.getElementById(targetId);
            if (!dropdown) {
                return;
            }

            const entry = {button, dropdown};
            mobileDropdownEntries.push(entry);
            dropdownEntryMap[targetId] = entry;

            button.addEventListener('click', function (event) {
                event.stopPropagation();
                const isOpen = !dropdown.classList.contains('hidden');
                if (isOpen) {
                    hideDropdownEntry(entry);
                } else {
                    closeOtherDropdowns(targetId);
                    dropdown.classList.remove('hidden');
                    button.setAttribute('aria-expanded', 'true');
                }
            });
        });

        document.addEventListener('click', function (event) {
            mobileDropdownEntries.forEach(entry => {
                if (entry.dropdown.classList.contains('hidden')) {
                    return;
                }
                if (!entry.dropdown.contains(event.target) && !entry.button.contains(event.target)) {
                    hideDropdownEntry(entry);
                }
            });
        });

        if (mobileMenuButton && mobileMenu) {
            mobileMenuButton.addEventListener('click', function () {
                mobileMenu.classList.toggle('hidden');
                window.closeAllMobileDropdowns();
            });
        } else {
            console.error('Mobile menu elements not found:', {button: !!mobileMenuButton, menu: !!mobileMenu});
        }

        // Mobile submenu toggle function
        window.toggleMobileSubmenu = function (submenuId) {
            const submenu = document.getElementById(submenuId);
            const arrow = document.getElementById(submenuId.replace('-submenu', '-arrow'));

            if (submenu) {
                submenu.classList.toggle('hidden');
            }

            if (arrow) {
                arrow.classList.toggle('rotate-180');
            }
        }

        // Mobile search toggle function
        window.toggleMobileSearch = function () {
            const mobileSearch = document.getElementById('mobile-search');
            if (mobileSearch) {
                mobileSearch.classList.toggle('hidden');
            }
        }
    });

    // Scroll behavior for contact bar and navigation
    let lastScrollTop = 0;
    const contactBar = document.getElementById('contact-bar');
    const mainNav = document.getElementById('main-nav');

    window.addEventListener('scroll', function () {
        const scrollTop = window.pageYOffset || document.documentElement.scrollTop;

        // Only apply scroll behavior on medium screens and up where contact bar is visible
        if (window.innerWidth >= 768) {
            // Determine scroll direction
            const scrollingDown = scrollTop > lastScrollTop;
            const scrollingUp = scrollTop < lastScrollTop;

            if (scrollTop <= 50) {
                // Always show contact bar when near the top
                if (contactBar) {
                    contactBar.style.transform = 'translateY(0)';
                }
                if (mainNav) {
                    mainNav.style.top = '48px'; // Height of contact bar (12 * 4px = 48px)
                }
            } else if (scrollingUp && scrollTop > 100) {
                // Show contact bar when scrolling up (but not immediately from the top)
                if (contactBar) {
                    contactBar.style.transform = 'translateY(0)';
                }
                if (mainNav) {
                    mainNav.style.top = '48px'; // Height of contact bar (12 * 4px = 48px)
                }
            } else if (scrollingDown && scrollTop > 100) {
                // Hide contact bar when scrolling down
                if (contactBar) {
                    contactBar.style.transform = 'translateY(-100%)';
                }
                if (mainNav) {
                    mainNav.style.top = '0';
                }
            }

            // Update last scroll position for next comparison
            lastScrollTop = scrollTop;
        }
    });

    // Handle window resize
    window.addEventListener('resize', function () {
        if (window.innerWidth < 1024) {
            // Reset styles for mobile
            if (contactBar) {
                contactBar.style.transform = '';
            }
            if (mainNav) {
                mainNav.style.top = '';
            }
        }
    });

    // Обработчик для мобильного селектора валют
    document.addEventListener('DOMContentLoaded', function () {
        const mobileCurrencyOptions = document.querySelectorAll('.mobile-currency-option');
        const currencySymbolTargets = document.querySelectorAll('[data-current-currency-symbol]');
        const currencyCodeTargets = document.querySelectorAll('[data-current-currency-code]');

        mobileCurrencyOptions.forEach(option => {
            option.addEventListener('click', function () {
                const currency = this.dataset.currency;
                const symbol = this.dataset.symbol;
                const dropdownContainerId = this.dataset.dropdownContainer;

                // Отправляем запрос на смену валюты
                const formData = new FormData();
                formData.append('currency', currency);
                formData.append('next', window.location.href);

                fetch('/currency/change/', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.content || document.querySelector('[name=csrfmiddlewaretoken]')?.value || '',
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            const previousActive = document.querySelectorAll('.mobile-currency-option.font-semibold');
                            previousActive.forEach(btn => btn.classList.remove('font-semibold', 'text-accent', 'bg-gray-50'));

                            // Update visible currency labels
                            currencySymbolTargets.forEach(label => {
                                label.textContent = symbol;
                            });
                            currencyCodeTargets.forEach(label => {
                                label.textContent = currency;
                            });

                            // Close dropdown that triggered the change
                            if (typeof window.hideMobileDropdownById === 'function') {
                                window.hideMobileDropdownById(dropdownContainerId || 'currency-submenu');
                            } else {
                                const fallbackDropdown = document.getElementById(dropdownContainerId || 'currency-submenu');
                                if (fallbackDropdown) {
                                    fallbackDropdown.classList.add('hidden');
                                }
                            }

                            // Store currency in localStorage for persistence
                            localStorage.setItem('selectedCurrency', currency);

                            this.classList.add('font-semibold', 'text-accent', 'bg-gray-50');

                            // Update Featured Properties prices if function exists (only on home page)
                            if (typeof updateAllPricesToHeaderCurrency === 'function') {
                                updateAllPricesToHeaderCurrency();
                            }

                            // Always trigger custom event for other components that might need to update
                            window.dispatchEvent(new CustomEvent('currencyChanged', {
                                detail: {currency: currency, symbol: symbol}
                            }));

                            // If no dynamic update handler exists, reload page
                            if (typeof updateAllPricesToHeaderCurrency !== 'function' && typeof updatePricePerSqm !== 'function') {
                                // On other pages (like property details), reload to update prices
                                window.location.reload();
                            }
                        } else {
                            console.error('Error changing currency:', data.error);
                            window.location.reload();
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        window.location.reload();
                    });
            });
        });
    });
</script>
