{% extends 'base.html' %}
{% load static %}
{% load i18n %}
{% load l10n %}
{% load currency_tags %}
{% load url_utils %}

{% block title %}{{ property.title }} - Undersun Estate{% endblock %}

{% block structured_data %}
    {% load l10n %}
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "Offer",
      "priceCurrency": "THB",
      "price": "{% if property.deal_type == 'rent' and property.price_rent_monthly_thb %}{{ property.price_rent_monthly_thb|unlocalize }}{% else %}{{ property.price_sale_thb|default:'0'|unlocalize }}{% endif %}",
      "availability": "{% if property.status == 'available' %}https://schema.org/InStock{% else %}https://schema.org/OutOfStock{% endif %}",
      "url": "{{ request.build_absolute_uri }}",
      "itemOffered": {
        "@type": "{% if property.property_type.name == 'condo' %}Apartment{% elif property.property_type.name == 'villa' %}SingleFamilyResidence{% elif property.property_type.name == 'townhouse' %}House{% else %}Residence{% endif %}",
        "name": "{{ property.title|escapejs }}",
        "description": "{{ property.short_description|default:property.description|striptags|truncatechars:400|escapejs }}",
        "image": [{% if property.images.exists %}{% for image in property.images.all %}"{{ image.medium_url|default:image.thumbnail_url|escape }}"{% if not forloop.last %}, {% endif %}{% endfor %}{% else %}"{% static 'images/no-image.svg' %}"{% endif %}],
        "numberOfRooms": {{ property.bedrooms|default:0 }},
        "floorSize": {
          "@type": "QuantitativeValue",
          "value": {{ property.area_total|default:'0'|unlocalize }},
          "unitCode": "MTK"
        },
        "address": {
          "@type": "PostalAddress",
          "addressLocality": "{{ property.location.name|default:property.district.name|default:''|escapejs }}",
          "addressRegion": "Phuket",
          "addressCountry": "TH"
        }
      }
    }
    </script>
{% endblock %}

{% block content %}
    <!-- Property Gallery Carousel -->
    <section class="py-4 sm:py-8 mt-6 sm:mt-10">
        <div class="max-w-7xl mx-auto px-2 sm:px-4">
            <!-- Main Carousel Container -->
            <div class="relative overflow-hidden rounded-lg sm:rounded-xl shadow-lg sm:shadow-2xl group">
                {% if property.images.exists %}
                    <!-- Carousel with Single/Dual Image Display -->
                    <div class="property-carousel relative h-64 sm:h-80 lg:h-[500px]">
                        {% for image in property.images.all %}
                            <!-- Mobile: Single Image Slides -->
                            <div class="property-slide-single md:hidden absolute inset-0 transition-opacity duration-1000 {% if forloop.counter0 == 0 %}opacity-100{% else %}opacity-0{% endif %}"
                                 data-slide-single="{{ forloop.counter0 }}">
                                <img src="{{ image.medium_url }}" alt="{{ property.title }}"
                                     class="w-full h-full object-cover cursor-pointer hover:scale-105 transition-transform duration-300 rounded-lg"
                                     onclick="openGallery({{ forloop.counter0 }})" loading="lazy">
                            </div>

                            <!-- Desktop: Dual Image Slides -->
                            {% if forloop.counter0|divisibleby:2 %}
                                <div class="property-slide-pair hidden md:block absolute inset-0 transition-opacity duration-1000 {% if forloop.counter0 == 0 %}opacity-100{% else %}opacity-0{% endif %}"
                                     data-slide-pair="{{ forloop.counter0|floatformat:0 }}">
                                    <div class="flex h-full gap-2">
                                        <!-- First Image -->
                                        <div class="flex-1">
                                            <img src="{{ image.medium_url }}" alt="{{ property.title }}"
                                                 class="w-full h-full object-cover cursor-pointer hover:scale-105 transition-transform duration-300 rounded-l-lg"
                                                 onclick="openGallery({{ forloop.counter0 }})" loading="lazy">
                                        </div>

                                        <!-- Second Image (if exists) -->
                                        {% if forloop.counter0|add:1 < property.images.count %}
                                            {% with next_index=forloop.counter0|add:1 %}
                                                <div class="flex-1">
                                                    {% for next_image in property.images.all %}
                                                        {% if forloop.counter0 == next_index %}
                                                            <img src="{{ next_image.medium_url }}"
                                                                 alt="{{ property.title }}"
                                                                 class="w-full h-full object-cover cursor-pointer hover:scale-105 transition-transform duration-300 rounded-r-lg"
                                                                 onclick="openGallery({{ next_index }})" loading="lazy">
                                                        {% endif %}
                                                    {% endfor %}
                                                </div>
                                            {% endwith %}
                                        {% else %}
                                            <!-- Show first image if we're at the last image (odd count) -->
                                            <div class="flex-1">
                                                {% with first_image=property.images.all|first %}
                                                    <img src="{{ first_image.medium_url }}" alt="{{ property.title }}"
                                                         class="w-full h-full object-cover cursor-pointer hover:scale-105 transition-transform duration-300 rounded-r-lg"
                                                         onclick="openGallery(0)" loading="lazy">
                                                {% endwith %}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            {% endif %}
                        {% endfor %}

                        <!-- Carousel Navigation -->
                        {% if property.images.count > 1 %}
                            <!-- Previous Button -->
                            <button onclick="previousSlide()"
                                    class="absolute left-2 sm:left-4 top-1/2 transform -translate-y-1/2 bg-white bg-opacity-80 hover:bg-opacity-100 text-gray-700 hover:text-gray-900 w-10 h-10 sm:w-12 sm:h-12 rounded-full transition-all duration-300 opacity-70 sm:opacity-0 group-hover:opacity-100 hover:scale-110 shadow-lg z-10 flex items-center justify-center">
                                <i class="fas fa-chevron-left text-base sm:text-lg"></i>
                            </button>

                            <!-- Next Button -->
                            <button onclick="nextSlide()"
                                    class="absolute right-2 sm:right-4 top-1/2 transform -translate-y-1/2 bg-white bg-opacity-80 hover:bg-opacity-100 text-gray-700 hover:text-gray-900 w-10 h-10 sm:w-12 sm:h-12 rounded-full transition-all duration-300 opacity-70 sm:opacity-0 group-hover:opacity-100 hover:scale-110 shadow-lg z-10 flex items-center justify-center">
                                <i class="fas fa-chevron-right text-base sm:text-lg"></i>
                            </button>

                            <!-- Slide Indicators for Image Pairs -->
                            <div class="absolute bottom-4 left-1/2 transform -translate-x-1/2 flex space-x-2 z-10">
                                {% for image in property.images.all %}
                                    {% if forloop.counter0|divisibleby:2 %}
                                        <button onclick="goToSlidePair({{ forloop.counter0|floatformat:0 }})"
                                                class="property-pair-indicator w-3 h-3 rounded-full transition-all duration-300 {% if forloop.counter0 == 0 %}bg-accent shadow-lg{% else %}bg-white bg-opacity-60 hover:bg-opacity-100{% endif %}"
                                                data-slide-pair="{{ forloop.counter0|floatformat:0 }}">
                                        </button>
                                    {% endif %}
                                {% endfor %}
                            </div>
                        {% endif %}


                        <!-- Photo Counter Badge -->
                        <div class="absolute top-2 sm:top-4 right-2 sm:right-4 bg-black bg-opacity-70 text-white px-2 py-1 sm:px-4 sm:py-2 rounded-full text-xs sm:text-sm font-medium z-10">
                            <i class="fas fa-images mr-1 sm:mr-2 text-xs sm:text-sm"></i>
                            <span id="current-photo">1</span> / {{ property.images.count }} <span
                                class="hidden sm:inline">{% trans "фото" %}</span>
                        </div>

                        <!-- Action Buttons -->
                        <div class="absolute bottom-2 sm:bottom-4 left-2 sm:left-4 flex space-x-1 sm:space-x-2 z-10">
                            <!-- Share Button -->
                            <button onclick="shareProperty()"
                                    class="bg-black bg-opacity-70 hover:bg-opacity-90 text-white p-2 sm:p-3 rounded-full text-xs sm:text-sm transition-all duration-300 hover:scale-110">
                                <i class="fas fa-share-alt"></i>
                            </button>

                            <!-- Favorite Button -->
                            <button onclick="toggleFavoriteDetail({{ property.id }})"
                                    class="bg-black bg-opacity-70 hover:bg-opacity-90 text-white p-2 sm:p-3 rounded-full text-xs sm:text-sm transition-all duration-300 hover:scale-110 carousel-favorite-btn">
                                <i class="far fa-heart"></i>
                            </button>
                        </div>

                    </div>
                {% else %}
                    <!-- No Images Fallback -->
                    <div class="h-96 lg:h-[500px] bg-gray-200 rounded-xl flex items-center justify-center">
                        <div class="text-center text-gray-500">
                            <i class="fas fa-image text-6xl mb-4"></i>
                            <p class="text-xl">{% trans "Изображения недоступны" %}</p>
                        </div>
                    </div>
                {% endif %}
            </div>

            <!-- Thumbnail Navigation -->
            {% if property.images.count > 1 %}
                <div class="mt-4 overflow-x-auto">
                    <div class="flex space-x-3 pb-2">
                        {% for image in property.images.all %}
                            <div class="flex-shrink-0 relative cursor-pointer group"
                                 onclick="goToSlidePairByImage({{ forloop.counter0 }})">
                                <img src="{{ image.thumbnail_url }}" alt="{{ property.title }}"
                                     class="w-20 h-20 object-cover rounded-lg transition-all duration-300 border-2 {% if forloop.counter0 == 0 or forloop.counter0 == 1 %}border-accent shadow-lg{% else %}border-transparent hover:border-accent/50{% endif %}"
                                     data-thumb="{{ forloop.counter0 }}">
                                <!-- Special indicator for cycled display -->
                                {% if property.images.count|divisibleby:2 == False and forloop.last %}
                                    <div class="absolute -top-1 -right-1 bg-accent text-white text-xs rounded-full w-5 h-5 flex items-center justify-center font-bold">
                                        ↻
                                    </div>
                                {% endif %}
                                <!-- Hover Overlay -->
                                <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-30 transition-all duration-300 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-eye text-white opacity-0 group-hover:opacity-100 transition-opacity duration-300"></i>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            {% endif %}
        </div>
    </section>

    <!-- Back Navigation -->
    <section class="pb-4">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex flex-col sm:flex-row sm:items-center space-y-3 sm:space-y-0 sm:space-x-4">
                <button onclick="goBackToCatalog()"
                        class="inline-flex items-center justify-center px-4 py-2 sm:px-3 sm:py-1 bg-accent hover:bg-yellow-600 text-white font-bold rounded transition-all duration-300 hover:scale-105 shadow-sm hover:shadow-md uppercase text-base sm:text-lg">
                    <i class="fas fa-arrow-left mr-2"></i>
                    {% trans "Назад" %}
                </button>

                <a href="
                        {% if property.deal_type == 'rent' %}{% url 'properties:property_rent' %}{% else %}{% url 'properties:property_sale' %}{% endif %}"
                   class="text-accent hover:text-yellow-600 font-semibold text-base sm:text-lg transition-colors duration-300 hover:underline uppercase text-center sm:text-left">
                    {{ property.property_type.name_plural|default:property.property_type.name_display }}
                </a>
            </div>

            <!-- Breadcrumbs -->
            <div class="mt-4">
                <nav class="flex items-center space-x-1 sm:space-x-2 text-xs sm:text-sm text-gray-600 overflow-x-auto pb-2">
                    {% url 'properties:property_rent' as rent_catalog_url %}
                    {% url 'properties:property_sale' as sale_catalog_url %}
                    <script type="application/ld+json">
                    {
                      "@context": "https://schema.org",
                      "@type": "BreadcrumbList",
                      "itemListElement": [
                        {
                          "@type": "ListItem",
                          "position": 1,
                          "item": {
                            "@id": "{% if property.deal_type == 'rent' %}{{ rent_catalog_url|absolute_url:request|escapejs }}{% else %}{{ sale_catalog_url|absolute_url:request|escapejs }}{% endif %}",
                            "name": "{% trans "Недвижимость" %}"
                          }
                        }{% if property.district %},
                        {
                          "@type": "ListItem",
                          "position": 2,
                          "item": {
                            "@id": "{{ property.district.get_absolute_url|absolute_url:request|escapejs }}",
                            "name": "{{ property.district.name|escapejs }}"
                          }
                        }{% endif %}{% if property.location %},
                        {
                          "@type": "ListItem",
                          "position": 3,
                          "item": {
                            "@id": "{{ property.location.get_absolute_url|absolute_url:request|escapejs }}",
                            "name": "{{ property.location.name|escapejs }}"
                          }
                        }{% endif %},{
                          "@type": "ListItem",
                          "position": {% if property.location %}4{% elif property.district %}3{% else %}2{% endif %},
                          "item": {
                            "@id": "{{ property.get_absolute_url|absolute_url:request|escapejs }}",
                            "name": "{{ property.title|escapejs }}"
                          }
                        }
                      ]
                    }
                    </script>
                    <a href="
                            {% if property.deal_type == 'rent' %}{% url 'properties:property_rent' %}{% else %}{% url 'properties:property_sale' %}{% endif %}"
                       class="hover:text-accent transition-colors duration-200 whitespace-nowrap">
                        {% trans "Недвижимость" %}
                    </a>
                    <i class="fas fa-chevron-right text-xs text-gray-400 flex-shrink-0"></i>

                    <a href="{{ property.district.get_absolute_url }}"
                       class="hover:text-accent transition-colors duration-200 whitespace-nowrap">
                        {{ property.district.name }}
                    </a>

                    {% if property.location %}
                        <i class="fas fa-chevron-right text-xs text-gray-400 flex-shrink-0"></i>
                        <a href="{{ property.location.get_absolute_url }}"
                           class="hover:text-accent transition-colors duration-200 whitespace-nowrap">
                            {{ property.location.name }}
                        </a>
                    {% endif %}

                    <i class="fas fa-chevron-right text-xs text-gray-400 flex-shrink-0"></i>
                    <span class="text-gray-900 font-medium whitespace-nowrap">{{ property.title|truncatechars:30 }}</span>
                </nav>
            </div>
        </div>
    </section>

    <!-- Property Information -->
    <section class="py-8">
        <div class="max-w-7xl mx-auto px-4">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Main Info -->
                <div class="lg:col-span-2">
                    <!-- Header -->
                    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                        <div class="flex flex-col sm:flex-row sm:justify-between sm:items-start space-y-4 sm:space-y-0">
                            <div class="flex-1">
                                <h1 class="text-2xl sm:text-3xl font-bold text-gray-900 mb-3 leading-tight">{{ property.title }}</h1>

                                <div class="flex flex-col sm:flex-row sm:items-center text-gray-600 mb-4 space-y-2 sm:space-y-0 sm:space-x-4">
                                    {% if property.legacy_id %}
                                        <span class="text-gray-500 text-sm">
                                        ID: {{ property.legacy_id }}
                                    </span>
                                    {% endif %}
                                    <a href="
                                            {% if property.location %}{{ property.location.get_absolute_url }}{% else %}{{ property.district.get_absolute_url }}{% endif %}"
                                       class="flex items-center space-x-1 text-primary hover:text-accent font-medium hover:underline transition-colors duration-200">
                                        <span>{% trans "Адрес" %}:</span>
                                        <span>{{ property.district.name }}</span>
                                        {% if property.location %}
                                            <span class="text-gray-400">,</span>
                                            <span>{{ property.location.name }}</span>
                                        {% endif %}
                                    </a>
                                                                    <a href="#property-map"
                                       class="flex items-center hover:text-primary transition-colors duration-200">
                                        <i class="fas fa-map-marker-alt mr-2 text-primary"></i>
                                        <span class="text-primary hover:text-accent font-medium">
                                        {% trans "На карте" %}
                                    </span>
                                    </a>
                                </div>
                                <div class="text-sm text-gray-500 mt-2">
                                    <i class="far fa-clock mr-2"></i>
                                    <span>{% trans "Обновлено" %}: {{ property.updated_at|date:"d.m.Y" }}</span>
                                </div>
                            </div>

                            <div class="flex flex-col items-end sm:text-right">
                                <div class="flex items-center gap-3 mb-2">
                                    <div id="main-price" class="text-2xl sm:text-3xl font-bold text-primary">{% price_in_currency property property.deal_type %}</div>
                                    <button class="bg-gray-100 hover:bg-gray-200 text-gray-600 w-10 h-10 rounded-full transition-colors favorite-btn flex-shrink-0 flex items-center justify-center"
                                            data-property-id="{{ property.id }}">
                                        <i class="far text-gray-600 fa-heart text-lg"></i>
                                    </button>
                                </div>
                                {% if property.deal_type == 'sale' or property.deal_type == 'both' %}
                                    {% if property.area_total %}
                                        <div id="price-per-sqm" class="text-sm text-gray-500 mb-3 self-end text-right w-full"></div>
                                    {% endif %}
                                {% endif %}

                                <!-- Contact Buttons -->
                                <div class="hidden sm:flex items-center gap-2 mt-2">
                                    <button onclick="openCallbackModal()"
                                            class="bg-accent hover:bg-yellow-600 text-white font-medium py-2 px-4 rounded transition-all duration-300 hover:scale-105 shadow-sm text-sm">
                                        <i class="fas fa-phone mr-1"></i>
                                        {% trans "Заказать звонок" %}
                                    </button>
                                    {% if property.contact_person and property.contact_person.whatsapp %}
                                        <a href="https://wa.me/{{ property.contact_person.whatsapp }}" target="_blank"
                                           class="bg-green-500 hover:bg-green-600 text-white w-10 h-10 rounded-full transition-all duration-300 hover:scale-105 shadow-sm flex items-center justify-center">
                                            <i class="fab fa-whatsapp text-lg"></i>
                                        </a>
                                    {% else %}
                                        <a href="https://wa.me/6663303313" target="_blank"
                                           class="bg-green-500 hover:bg-green-600 text-white w-10 h-10 rounded-full transition-all duration-300 hover:scale-105 shadow-sm flex items-center justify-center">
                                            <i class="fab fa-whatsapp text-lg"></i>
                                        </a>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Mobile Call Button -->
                        <div class="lg:hidden mt-4">
                            <button onclick="openViewingModal()"
                                    class="w-full bg-accent hover:bg-yellow-600 text-white font-bold py-3 px-6 rounded-lg transition-all duration-300 hover:scale-105 shadow-md flex items-center justify-center">
                                <i class="fas fa-phone mr-2"></i>
                                {% trans "Заказать звонок" %}
                            </button>
                        </div>
                    </div>

                    <!-- Key Features -->
                    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                        <h2 class="text-xl font-semibold text-gray-900 mb-4">{% trans "Основные характеристики" %}</h2>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                            {% if property.bedrooms %}
                                <div class="flex items-center p-4 bg-gray-50 hover:bg-gray-100 rounded-xl border border-gray-200 hover:border-primary transition-all duration-300">
                                    <div class="flex-shrink-0 w-12 h-12 bg-primary bg-opacity-10 rounded-lg flex items-center justify-center mr-4">
                                        <i class="fas fa-bed text-primary text-xl"></i>
                                    </div>
                                    <div class="flex-grow">
                                        <div class="font-bold text-xl text-gray-900">{{ property.bedrooms }}</div>
                                        <div class="text-sm text-gray-600 font-medium">{% trans "Спален" %}</div>
                                    </div>
                                </div>
                            {% endif %}

                            {% if property.bathrooms %}
                                <div class="flex items-center p-4 bg-gray-50 hover:bg-gray-100 rounded-xl border border-gray-200 hover:border-primary transition-all duration-300">
                                    <div class="flex-shrink-0 w-12 h-12 bg-primary bg-opacity-10 rounded-lg flex items-center justify-center mr-4">
                                        <i class="fas fa-bath text-primary text-xl"></i>
                                    </div>
                                    <div class="flex-grow">
                                        <div class="font-bold text-xl text-gray-900">{{ property.bathrooms }}</div>
                                        <div class="text-sm text-gray-600 font-medium">{% trans "Ванных" %}</div>
                                    </div>
                                </div>
                            {% endif %}

                            {% if property.area_total %}
                                <div class="flex items-center p-4 bg-gray-50 hover:bg-gray-100 rounded-xl border border-gray-200 hover:border-primary transition-all duration-300">
                                    <div class="flex-shrink-0 w-12 h-12 bg-primary bg-opacity-10 rounded-lg flex items-center justify-center mr-4">
                                        <i class="fas fa-ruler-combined text-primary text-xl"></i>
                                    </div>
                                    <div class="flex-grow">
                                        <div class="font-bold text-xl text-gray-900">{{ property.area_total }}</div>
                                        <div class="text-sm text-gray-600 font-medium">{% trans "м²" %}</div>
                                    </div>
                                </div>
                            {% endif %}

                            {% if property.area_land %}
                                <div class="flex items-center p-4 bg-gray-50 hover:bg-gray-100 rounded-xl border border-gray-200 hover:border-primary transition-all duration-300">
                                    <div class="flex-shrink-0 w-12 h-12 bg-primary bg-opacity-10 rounded-lg flex items-center justify-center mr-4">
                                        <i class="fas fa-globe text-primary text-xl"></i>
                                    </div>
                                    <div class="flex-grow">
                                        <div class="font-bold text-xl text-gray-900">{{ property.area_land }}</div>
                                        <div class="text-sm text-gray-600 font-medium">{% trans "Участок м²" %}</div>
                                    </div>
                                </div>
                            {% endif %}

                            {% if property.floor %}
                                <div class="flex items-center p-4 bg-gray-50 hover:bg-gray-100 rounded-xl border border-gray-200 hover:border-primary transition-all duration-300">
                                    <div class="flex-shrink-0 w-12 h-12 bg-primary bg-opacity-10 rounded-lg flex items-center justify-center mr-4">
                                        <i class="fas fa-layer-group text-primary text-xl"></i>
                                    </div>
                                    <div class="flex-grow">
                                        <div class="font-bold text-xl text-gray-900">
                                            {{ property.floor }}{% if property.floors_total %}/
                                                {{ property.floors_total }}{% endif %}</div>
                                        <div class="text-sm text-gray-600 font-medium">{% trans "Этаж" %}</div>
                                    </div>
                                </div>
                            {% endif %}

                            {% if property.year_built %}
                                <div class="flex items-center p-4 bg-gray-50 hover:bg-gray-100 rounded-xl border border-gray-200 hover:border-primary transition-all duration-300">
                                    <div class="flex-shrink-0 w-12 h-12 bg-primary bg-opacity-10 rounded-lg flex items-center justify-center mr-4">
                                        <i class="fas fa-calendar-alt text-primary text-xl"></i>
                                    </div>
                                    <div class="flex-grow">
                                        <div class="font-bold text-xl text-gray-900">{{ property.year_built }}</div>
                                        <div class="text-sm text-gray-600 font-medium">{% trans "Год" %}</div>
                                    </div>
                                </div>
                            {% endif %}

{#                            {% if property.parking %}#}
{#                                <div class="flex items-center p-4 bg-gray-50 hover:bg-gray-100 rounded-xl border border-gray-200 hover:border-primary transition-all duration-300">#}
{#                                    <div class="flex-shrink-0 w-12 h-12 bg-primary bg-opacity-10 rounded-lg flex items-center justify-center mr-4">#}
{#                                        <i class="fas fa-car text-primary text-xl"></i>#}
{#                                    </div>#}
{#                                    <div class="flex-grow">#}
{#                                        <div class="font-bold text-xl text-gray-900">{% trans "Есть" %}</div>#}
{#                                        <div class="text-sm text-gray-600 font-medium">{% trans "Парковка" %}</div>#}
{#                                    </div>#}
{#                                </div>#}
{#                            {% endif %}#}

{#                            {% if property.pool %}#}
{#                                <div class="flex items-center p-4 bg-gray-50 hover:bg-gray-100 rounded-xl border border-gray-200 hover:border-primary transition-all duration-300">#}
{#                                    <div class="flex-shrink-0 w-12 h-12 bg-primary bg-opacity-10 rounded-lg flex items-center justify-center mr-4">#}
{#                                        <i class="fas fa-swimming-pool text-primary text-xl"></i>#}
{#                                    </div>#}
{#                                    <div class="flex-grow">#}
{#                                        <div class="font-bold text-xl text-gray-900">{% trans "Есть" %}</div>#}
{#                                        <div class="text-sm text-gray-600 font-medium">{% trans "Бассейн" %}</div>#}
{#                                    </div>#}
{#                                </div>#}
{#                            {% endif %}#}
                        </div>
                    </div>

                    <!-- Description -->
                    {% if property.description %}
                        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                            <div class="prose max-w-none">
                                <h2 class="text-xl font-semibold text-gray-900 mb-3">{% trans "Описание" %}</h2>
                                <div class="relative">
                                    <div id="description-content"
                                         class="description-content max-h-52 overflow-hidden transition-all duration-500 ease-in-out text-gray-700 leading-relaxed">
                                        <div class="tinymce-content">
                                            {{ property.description|safe }}
                                        </div>
                                    </div>
                                    <!-- Gradient overlay -->
                                    <div id="description-gradient"
                                         class="absolute bottom-0 left-0 right-0 h-12 bg-gradient-to-t from-white to-transparent pointer-events-none transition-opacity duration-300"></div>
                                    <!-- Expand button -->
                                    <button id="description-toggle" onclick="toggleDescription()"
                                            class="mt-3 text-primary hover:text-accent font-medium transition-colors duration-200 flex items-center">
                                        <span id="toggle-text">{% trans "Показать полностью" %}</span>
                                        <i id="toggle-icon"
                                           class="fas fa-chevron-down ml-2 transition-transform duration-300"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    {% endif %}

                    <!-- Features & Amenities -->
                    {% if property.features.exists %}
                        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                            <h2 class="text-xl font-semibold text-gray-900 mb-4">{% trans "Особенности и удобства" %}</h2>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 md:gap-4">
                                {% for feature_relation in property.features.all %}
                                    <div class="flex items-center p-2 rounded-lg hover:bg-gray-50 transition-colors">
                                        {% if feature_relation.feature.icon %}
                                            <i class="{{ feature_relation.feature.icon }} text-primary mr-3 text-lg"></i>
                                        {% else %}
                                            <i class="fas fa-check text-green-500 mr-3 text-lg"></i>
                                        {% endif %}
                                        <span class="font-medium">{{ feature_relation.feature.name }}
                                                {% if feature_relation.value %}:
                                                    <span class="text-gray-600">{{ feature_relation.value }}</span>{% endif %}</span>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    {% endif %}


                    <!-- Map -->
                    {% if property.latitude and property.longitude %}
                        <div class="bg-white rounded-lg shadow-md p-6">
                            <h2 class="text-xl font-semibold text-gray-900 mb-4">{% trans "Расположение" %}</h2>

                            <!-- Location Details -->
                            <div class="space-y-2 mb-4">
                                <div class="flex items-center justify-between text-gray-700">
                                    <span class="font-medium">{% trans "Район" %}</span>
                                    <span class="flex-1 border-b border-dotted border-gray-300 mx-3"></span>
                                    <span class="text-primary font-medium">{{ property.district.name }}</span>
                                </div>
                                {% if property.location %}
                                    <div class="flex items-center justify-between text-gray-700">
                                        <span class="font-medium">{% trans "Локация" %}</span>
                                        <span class="flex-1 border-b border-dotted border-gray-300 mx-3"></span>
                                        <span class="text-primary font-medium">{{ property.location.name }}</span>
                                    </div>
                                {% endif %}
                            </div>

                            <div id="property-map" class="w-full h-64 rounded-lg"></div>
                        </div>
                    {% endif %}

                    <!-- Additional Details CTA -->
                    <div class="bg-primary rounded-lg shadow-md p-6 text-center">
                        <h2 class="text-xl font-semibold text-white mb-3">{% trans "Остались вопросы по объекту?" %}</h2>
                        <button onclick="openDetailsModal()"
                                class="bg-accent hover:bg-yellow-600 text-gray-900 font-medium py-3 px-6 rounded-lg transition-all duration-300 hover:scale-105 shadow-lg">
                            {% trans "Уточнить детали" %}
                        </button>
                    </div>
                </div>

                <!-- Sidebar -->
                <div id="contact-sidebar-wrapper" class="lg:col-span-1 lg:relative">
                    <!-- Contact Form -->
                    <div id="property-contact-form" class="bg-white rounded-lg shadow-md p-4 sm:p-6">
                        <h3 class="text-xl font-semibold text-gray-900 mb-6">{% trans "Заинтересовались объектом?" %}</h3>

                        <!-- Manager Info -->
                        <div class="border-b border-gray-200 pb-6 mb-6">
                            {% if property.contact_person %}
                                <div class="flex items-center space-x-4 mb-4">
                                    <div class="w-16 h-16 rounded-full overflow-hidden bg-gray-200 flex-shrink-0">
                                        {% if property.contact_person.photo %}
                                            <img src="{{ property.contact_person.photo.url }}"
                                                 alt="{{ property.contact_person.first_name }} {{ property.contact_person.last_name }}"
                                                 class="w-full h-full object-cover">
                                        {% else %}
                                            <div class="w-full h-full bg-primary bg-opacity-10 flex items-center justify-center text-primary text-2xl font-bold">
                                                {{ property.contact_person.first_name|first|upper }}
                                            </div>
                                        {% endif %}
                                    </div>
                                    <div class="flex-1">
                                        <h4 class="font-semibold text-gray-900 text-lg">{{ property.contact_person.first_name }} {{ property.contact_person.last_name }}</h4>
                                        <p class="text-gray-600 text-sm">{{ property.contact_person.position }}</p>
                                    </div>
                                </div>

                                <div class="space-y-3 text-sm">
                                    {% if property.contact_person.phone %}
                                        <div class="flex items-center space-x-3">
                                            <i class="fas fa-phone text-primary w-4"></i>
                                            <a href="tel:{{ property.contact_person.phone }}"
                                               class="text-gray-700 hover:text-primary transition-colors">
                                                {{ property.contact_person.phone }}
                                            </a>
                                        </div>
                                    {% endif %}
                                    {% if property.contact_person.email %}
                                        <div class="flex items-center space-x-3">
                                            <i class="fas fa-envelope text-primary w-4"></i>
                                            <a href="mailto:{{ property.contact_person.email }}"
                                               class="text-gray-700 hover:text-primary transition-colors">
                                                {{ property.contact_person.email }}
                                            </a>
                                        </div>
                                    {% endif %}
                                    {% if property.contact_person.whatsapp %}
                                        <div class="flex items-center space-x-3">
                                            <i class="fab fa-whatsapp text-accent w-4"></i>
                                            <a href="https://wa.me/{{ property.contact_person.whatsapp }}"
                                               target="_blank"
                                               class="text-gray-700 hover:text-accent transition-colors">
                                                {% trans "Написать в WhatsApp" %}
                                            </a>
                                        </div>
                                    {% endif %}
                                </div>
                            {% else %}
                                <!-- Fallback if no agent assigned -->
                                <div class="flex items-center space-x-4 mb-4">
                                    <div class="w-16 h-16 rounded-full overflow-hidden bg-gray-200 flex-shrink-0">
                                        <div class="w-full h-full bg-primary bg-opacity-10 flex items-center justify-center text-primary text-2xl font-bold">
                                            U
                                        </div>
                                    </div>
                                    <div class="flex-1">
                                        <h4 class="font-semibold text-gray-900 text-lg">Undersun Estate</h4>
                                        <p class="text-gray-600 text-sm">{% trans "Менеджер по недвижимости" %}</p>
                                    </div>
                                </div>

                                <div class="space-y-3 text-sm">
                                    <div class="flex items-center space-x-3">
                                        <i class="fas fa-phone text-primary w-4"></i>
                                        <a href="tel:+6663303313"
                                           class="text-gray-700 hover:text-primary transition-colors">
                                            +66 633 033 13
                                        </a>
                                    </div>
                                    <div class="flex items-center space-x-3">
                                        <i class="fas fa-envelope text-primary w-4"></i>
                                        <a href="mailto:info@undersunestate.com"
                                           class="text-gray-700 hover:text-primary transition-colors">
                                            info@undersunestate.com
                                        </a>
                                    </div>
                                    <div class="flex items-center space-x-3">
                                        <i class="fab fa-whatsapp text-accent w-4"></i>
                                        <a href="https://wa.me/6663303313" target="_blank"
                                           class="text-gray-700 hover:text-accent transition-colors">
                                            {% trans "Написать в WhatsApp" %}
                                        </a>
                                    </div>
                                </div>
                            {% endif %}
                        </div>

                        <!-- Action Buttons -->
                        <div class="space-y-3">
                            <button onclick="openViewingModal()"
                                    class="w-full bg-primary hover:bg-tertiary text-white font-medium py-3 px-4 rounded-lg transition-colors duration-200 flex items-center justify-center">
                                <i class="fas fa-calendar-alt mr-2"></i>
                                {% trans "Записаться на просмотр" %}
                            </button>
                            <button onclick="openConsultationModal()"
                                    class="w-full bg-accent hover:bg-yellow-500 text-white font-medium py-3 px-4 rounded-lg transition-colors duration-200 flex items-center justify-center">
                                <i class="fas fa-comments mr-2"></i>
                                {% trans "Получить консультацию" %}
                            </button>
                        </div>

                        <!-- Quick Contact -->
                        <div class="mt-6 pt-6 border-t border-gray-200">
                            <div class="grid grid-cols-2 gap-3">
                                {% if property.contact_person and property.contact_person.phone %}
                                    <a href="tel:{{ property.contact_person.phone }}"
                                       class="flex items-center justify-center bg-primary hover:bg-tertiary text-white py-2 px-3 rounded-lg transition-colors text-sm font-medium">
                                        <i class="fas fa-phone mr-2"></i>{% trans "Позвонить" %}
                                    </a>
                                {% else %}
                                    <a href="tel:+6663303313"
                                       class="flex items-center justify-center bg-primary hover:bg-tertiary text-white py-2 px-3 rounded-lg transition-colors text-sm font-medium">
                                        <i class="fas fa-phone mr-2"></i>{% trans "Позвонить" %}
                                    </a>
                                {% endif %}
                                {% if property.contact_person and property.contact_person.whatsapp %}
                                    <a href="https://wa.me/{{ property.contact_person.whatsapp }}" target="_blank"
                                       class="flex items-center justify-center bg-accent hover:bg-yellow-500 text-white py-2 px-3 rounded-lg transition-colors text-sm font-medium">
                                        <i class="fab fa-whatsapp mr-2"></i>WhatsApp
                                    </a>
                                {% else %}
                                    <a href="https://wa.me/6663303313" target="_blank"
                                       class="flex items-center justify-center bg-accent hover:bg-yellow-500 text-white py-2 px-3 rounded-lg transition-colors text-sm font-medium">
                                        <i class="fab fa-whatsapp mr-2"></i>WhatsApp
                                    </a>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Similar Properties -->
    {% if similar_properties %}
        <div id="similar-sentinel" class="block h-1" aria-hidden="true"></div>
        <section id="similar-properties" class="py-16 bg-gray-50">
            <div class="max-w-7xl mx-auto px-4">
                <!-- Header -->
                <div class="text-center mb-12">
                    <h2 class="text-3xl font-bold text-gray-900 mb-4">{% trans "Похожие объекты" %}</h2>
                    <div class="w-24 h-1 bg-accent mx-auto mt-6 rounded-full"></div>
                </div>

                <!-- Properties Grid -->
                <div class="similar-properties-grid mb-12">
                    {% for property in similar_properties %}
                        {% include 'properties/card.html' %}
                    {% endfor %}
                </div>
                <!-- Contact Form Section -->
    <section class="py-8 bg-white">
        <div class="max-w-7xl mx-auto px-4">
            <!-- Header -->
            <div class="text-center mb-6">
                <h2 class="text-2xl font-bold text-gray-900 mb-3">{% trans "Не нашли подходящий вариант?" %}</h2>
                <div class="w-20 h-1 bg-accent mx-auto rounded-full"></div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Contact Form -->
                <div class="bg-gray-50 rounded-2xl shadow-lg p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">
                        {% trans "Оставьте заявку на индивидуальный подбор недвижимости" %}
                    </h3>

                    <form id="customSelectionForm" class="space-y-4">
                        {% csrf_token %}
                        <input type="hidden" name="inquiry_type" value="custom_selection">

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                {% trans "Имя" %} <span class="text-red-500">*</span>
                            </label>
                            <input type="text" name="name" required
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-accent focus:border-transparent transition-all duration-200">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                {% trans "Телефон" %} <span class="text-red-500">*</span>
                            </label>
                            <input type="tel" name="phone" id="custom-selection-phone" required
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-accent focus:border-transparent transition-all duration-200">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                {% trans "Email" %} <span class="text-red-500">*</span>
                            </label>
                            <input type="email" name="email" required
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-accent focus:border-transparent transition-all duration-200">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                {% trans "Удобное время для общения / Часовой пояс" %}
                            </label>
                            <input type="text" name="preferred_time"
                                   placeholder="{% trans 'Например: 10:00-18:00 UTC+7' %}"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-accent focus:border-transparent transition-all duration-200">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                {% trans "Дополнительная информация" %}
                            </label>
                            <textarea name="message" rows="3"
                                      placeholder="{% trans 'Расскажите о ваших пожеланиях к недвижимости...' %}"
                                      class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-accent focus:border-transparent transition-all duration-200"></textarea>
                        </div>

                        <button type="submit"
                                class="w-full bg-gradient-to-r from-accent to-yellow-500 hover:from-yellow-500 hover:to-accent text-gray-900 font-bold py-3 px-6 rounded-lg transition-all duration-300 hover:scale-105 shadow-lg hover:shadow-xl">
                            <i class="fas fa-paper-plane mr-2"></i>
                            {% trans "Отправить заявку" %}
                        </button>

                        <div id="custom-selection-message" class="hidden p-4 rounded-lg text-sm"></div>
                    </form>
                </div>

                <!-- Office Information -->
                <div class="bg-gradient-to-br from-primary to-tertiary rounded-2xl shadow-lg p-6 h-full flex flex-col justify-center">
                    <!-- Logo Header -->
                    <div class="text-center mb-6">
                        <div class="inline-flex items-center justify-center bg-white rounded-xl px-5 py-3 shadow-md mb-3">
                            <img src="{% static 'images/home_page/homepage_visit_section/undersun_yellow_black.svg' %}"
                                 alt="Undersun Estate"
                                 class="h-7">
                        </div>
                        <h3 class="text-lg font-semibold text-white">
                            {% trans "Или посетите наш офис на Пхукете" %}
                        </h3>
                    </div>

                    <!-- Contact Information Grid -->
                    <div class="space-y-3">
                        <!-- Address -->
                        <div class="flex items-start space-x-3 bg-white bg-opacity-10 backdrop-blur-sm rounded-lg p-3 hover:bg-opacity-20 transition-all duration-300">
                            <div class="flex-shrink-0 w-9 h-9 bg-accent rounded-lg flex items-center justify-center">
                                <i class="fas fa-map-marker-alt text-white"></i>
                            </div>
                            <div class="flex-grow">
                                <p class="text-sm font-medium text-white leading-relaxed">
                                    59/358 Moo.4, Kathu Sub-District, <br>
                                    Kathu District, Phuket Province 83120
                                </p>
                            </div>
                        </div>

                        <!-- Phone -->
                        <div class="flex items-start space-x-3 bg-white bg-opacity-10 backdrop-blur-sm rounded-lg p-3 hover:bg-opacity-20 transition-all duration-300">
                            <div class="flex-shrink-0 w-9 h-9 bg-accent rounded-lg flex items-center justify-center">
                                <i class="fas fa-phone text-white"></i>
                            </div>
                            <div class="flex-grow">
                                <a href="tel:+66827268615" class="text-sm font-medium text-white hover:text-accent transition-colors">
                                    +66 82 726 8615
                                </a>
                            </div>
                        </div>

                        <!-- Email -->
                        <div class="flex items-start space-x-3 bg-white bg-opacity-10 backdrop-blur-sm rounded-lg p-3 hover:bg-opacity-20 transition-all duration-300">
                            <div class="flex-shrink-0 w-9 h-9 bg-accent rounded-lg flex items-center justify-center">
                                <i class="fas fa-envelope text-white"></i>
                            </div>
                            <div class="flex-grow">
                                <a href="mailto:info@undersunestate.com" class="text-sm font-medium text-white hover:text-accent transition-colors">
                                    info@undersunestate.com
                                </a>
                            </div>
                        </div>

                        <!-- Working Hours -->
                        <div class="flex items-start space-x-3 bg-white bg-opacity-10 backdrop-blur-sm rounded-lg p-3 hover:bg-opacity-20 transition-all duration-300">
                            <div class="flex-shrink-0 w-9 h-9 bg-accent rounded-lg flex items-center justify-center">
                                <i class="fas fa-clock text-white"></i>
                            </div>
                            <div class="flex-grow">
                                <p class="text-sm font-medium text-white">
                                    {% trans "Пн-Пт: 9:00-18:00" %}
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
                <!-- Newsletter Subscription -->
                <div class="mt-12 bg-accent bg-opacity-10 rounded-xl p-6 lg:p-8">
                    <div class="flex flex-col lg:flex-row items-center gap-6">
                        <!-- Content -->
                        <div class="flex-1 text-center lg:text-left">
                            <h2 class="text-2xl font-bold text-gray-900 mb-2">{% trans "Подписка на новости" %}</h2>
                            <p class="text-sm text-gray-600 mb-4">{% trans "Получить последние новости и интересные предложения о недвижимости" %}</p>

                            <!-- Newsletter Form -->
                            <form id="newsletterForm" class="flex flex-col sm:flex-row gap-3 max-w-md mx-auto lg:mx-0">
                                {% csrf_token %}
                                <input type="email"
                                       name="email"
                                       placeholder="{% trans 'Введите ваш email' %}"
                                       required
                                       class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-accent focus:border-transparent text-sm">
                                <button type="submit"
                                        class="bg-accent hover:bg-yellow-500 text-white font-semibold py-2 px-5 rounded-lg transition-colors duration-300 hover:scale-105 transform text-sm">
                                    {% trans "Подписаться" %}
                                </button>
                            </form>

                            <div id="newsletter-message" class="hidden mt-3 p-2 rounded-md text-xs"></div>
                        </div>

                        <!-- Image -->
                        <div class="flex-shrink-0 hidden lg:block">
                            <img src="{% static 'images/detail_property/Tooltip container.png' %}"
                                 alt="{% trans 'Подписка на новости' %}"
                                 class="w-32 h-auto">
                        </div>
                    </div>
                </div>
            </div>
        </section>
    {% else %}
        <!-- No Similar Properties Available -->
        <section id="similar-properties" class="py-16 bg-gray-50">
            <div class="max-w-7xl mx-auto px-4">
                <div class="text-center">
                    <div class="bg-white rounded-xl shadow-lg p-12 max-w-2xl mx-auto">
                        <div class="w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-6">
                            <i class="fas fa-search text-gray-400 text-2xl"></i>
                        </div>
                        <h3 class="text-2xl font-bold text-gray-900 mb-4">
                            {% trans "Похожие объекты не найдены" %}
                        </h3>
                        <p class="text-gray-600 mb-8">
                            {% trans "К сожалению, в данный момент нет похожих объектов. Рекомендуем посмотреть другие варианты в нашем каталоге." %}
                        </p>
                        <div class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-4 justify-center">
                            <a href="{% url 'properties:property_sale' %}"
                               class="bg-primary hover:bg-tertiary text-white px-8 py-3 rounded-lg font-medium transition-colors duration-300 hover:scale-105 transform">
                                {% trans "Посмотреть все объекты" %}
                            </a>
                            <a href="{% url 'core:contact' %}"
                               class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-8 py-3 rounded-lg font-medium transition-colors duration-300 hover:scale-105 transform">
                                {% trans "Связаться с агентом" %}
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    {% endif %}

    <!-- Gallery Modal -->
    <div id="gallery-modal"
         class="fixed inset-0 bg-black bg-opacity-90 z-50 hidden transition-opacity duration-300 backdrop-blur-sm"
         onclick="closeGallery()" data-gallery-backdrop>
        <div class="absolute inset-0 flex items-center justify-center p-4" onclick="event.stopPropagation()" data-gallery-content>
            <div class="relative max-w-6xl w-full">
                <!-- Header -->
                <div class="absolute top-4 left-4 z-20 hidden md:block">
                    <div class="text-white text-lg font-medium bg-black bg-opacity-50 px-4 py-2 rounded-full">
                        {{ property.title }}
                    </div>
                </div>
                <button onclick="closeGallery()"
                        class="absolute top-4 right-4 text-white text-2xl bg-black bg-opacity-50 hover:bg-opacity-70 p-3 rounded-full transition-all duration-200 hover:scale-110">
                    <i class="fas fa-times"></i>
                </button>

                <!-- Main Image -->
                <div class="relative">
                    <img id="gallery-image" src="" alt="{{ property.title }}"
                         class="w-full h-auto max-h-[85vh] object-contain rounded-lg shadow-2xl">

                    <!-- Loading Indicator -->
                    <div id="gallery-loading"
                         class="absolute inset-0 flex items-center justify-center bg-gray-900 bg-opacity-50 rounded-lg hidden">
                        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-white"></div>
                    </div>
                </div>

                <!-- Navigation Buttons -->
                <div class="absolute inset-y-0 left-4 hidden md:flex items-center">
                    <button onclick="previousImage()"
                            class="text-white text-2xl bg-black bg-opacity-50 hover:bg-opacity-70 p-3 rounded-full transition-all duration-200 hover:scale-110 backdrop-blur-sm">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                </div>

                <div class="absolute inset-y-0 right-4 hidden md:flex items-center">
                    <button onclick="nextImage()"
                            class="text-white text-2xl bg-black bg-opacity-50 hover:bg-opacity-70 p-3 rounded-full transition-all duration-200 hover:scale-110 backdrop-blur-sm">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>

                <!-- Footer Info -->
                <div class="absolute bottom-4 left-0 right-0 z-20 hidden md:flex justify-between items-center px-6">
                    <div class="text-white text-sm bg-black bg-opacity-50 px-4 py-2 rounded-full backdrop-blur-sm">
                        <span id="gallery-counter">1 / 1</span>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="downloadImage()"
                                class="text-white text-sm bg-black bg-opacity-50 hover:bg-opacity-70 px-4 py-2 rounded-full transition-all duration-200 backdrop-blur-sm">
                            <i class="fas fa-download mr-2"></i>{% trans "Скачать" %}
                        </button>
                        <button onclick="shareImage()"
                                class="text-white text-sm bg-black bg-opacity-50 hover:bg-opacity-70 px-4 py-2 rounded-full transition-all duration-200 backdrop-blur-sm">
                            <i class="fas fa-share mr-2"></i>{% trans "Поделиться" %}
                        </button>
                    </div>
                </div>

                <!-- Thumbnail Navigation -->
                {% if property.images.count > 1 %}
                    <div class="absolute bottom-20 left-1/2 transform -translate-x-1/2 z-20 hidden md:block">
                        <div class="flex space-x-2 bg-black bg-opacity-50 p-2 rounded-full backdrop-blur-sm overflow-x-auto max-w-xs md:max-w-md">
                            {% for image in property.images.all %}
                                <img src="{{ image.thumbnail_url }}" alt="{{ property.title }}"
                                     class="w-12 h-12 object-cover rounded cursor-pointer border-2 border-transparent hover:border-white transition-all duration-200 gallery-thumb"
                                     data-index="{{ forloop.counter0 }}"
                                     onclick="openGallery({{ forloop.counter0 }})">
                            {% endfor %}
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Viewing Modal -->
    <div id="viewing-modal"
         class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden transition-opacity duration-300 backdrop-blur-sm">
        <div class="absolute inset-0 flex items-center justify-center p-4" onclick="event.stopPropagation()">
            <div class="relative bg-white rounded-xl shadow-2xl max-w-lg w-full max-h-[90vh] overflow-y-auto">
                <!-- Header -->
                <div class="flex justify-between items-center p-6 border-b border-gray-200">
                    <h3 class="text-xl font-bold text-gray-900">{% trans "Записаться на просмотр" %}</h3>
                    <button onclick="closeViewingModal()"
                            class="text-gray-400 hover:text-gray-600 p-2 rounded-full hover:bg-gray-100 transition-colors duration-200">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>

                <!-- Body -->
                <div class="p-6">
                    <div class="mb-6">
                        <h4 class="text-lg font-semibold text-gray-900 mb-2">{{ property.title }}</h4>
                        <p class="text-gray-600">{% trans "Укажите удобное время для просмотра объекта. Наш менеджер свяжется с вами для подтверждения встречи." %}</p>
                    </div>

                    <form id="viewingRequestForm" data-property-id="{{ property.id }}" class="space-y-4">
                        {% csrf_token %}
                        <input type="hidden" name="inquiry_type" value="viewing">

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">{% trans "Ваше имя" %} *</label>
                            <input type="text" name="name" required
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary focus:border-transparent">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">{% trans "Телефон" %} *</label>
                            <input type="tel" name="phone" required
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary focus:border-transparent">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">{% trans "Email" %}</label>
                            <input type="email" name="email"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary focus:border-transparent">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">{% trans "Желаемая дата и время" %}</label>
                            <input type="datetime-local" name="preferred_date"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary focus:border-transparent">
                        </div>

                        <div class="flex space-x-3 pt-4">
                            <button type="submit"
                                    class="flex-1 bg-accent hover:bg-yellow-600 text-white font-bold py-3 px-6 rounded-lg transition-all duration-300 hover:scale-105 shadow-lg">
                                {% trans "Записаться на просмотр" %}
                            </button>
                            <button type="button" onclick="closeViewingModal()"
                                    class="px-6 py-3 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors duration-200">
                                {% trans "Отмена" %}
                            </button>
                        </div>

                        <div id="viewing-message" class="hidden p-3 rounded-md text-sm"></div>
                    </form>

                    <!-- Alternative Contact Methods -->
                    <div class="mt-6 pt-6 border-t border-gray-200">
                        <p class="text-sm text-gray-600 mb-4">{% trans "Или свяжитесь с нами напрямую:" %}</p>
                        <div class="flex space-x-2">
                            <a href="tel:+6663303313"
                               class="flex-1 bg-primary hover:bg-blue-700 text-white text-center py-2 px-3 rounded-md transition-colors text-sm">
                                <i class="fas fa-phone mr-1"></i>{% trans "Позвонить" %}
                            </a>
                            <a href="https://wa.me/6663303313" target="_blank"
                               class="flex-1 bg-accent hover:bg-yellow-500 text-white text-center py-2 px-3 rounded-md transition-colors text-sm">
                                <i class="fab fa-whatsapp mr-1"></i>WhatsApp
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Consultation Modal -->
    <div id="consultation-modal"
         class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden transition-opacity duration-300 backdrop-blur-sm">
        <div class="absolute inset-0 flex items-center justify-center p-4" onclick="event.stopPropagation()">
            <div class="relative bg-white rounded-xl shadow-2xl max-w-lg w-full max-h-[90vh] overflow-y-auto">
                <!-- Header -->
                <div class="flex justify-between items-center p-6 border-b border-gray-200">
                    <h3 class="text-xl font-bold text-gray-900">{% trans "Получить консультацию" %}</h3>
                    <button onclick="closeConsultationModal()"
                            class="text-gray-400 hover:text-gray-600 p-2 rounded-full hover:bg-gray-100 transition-colors duration-200">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>

                <!-- Body -->
                <div class="p-6">
                    <div class="mb-6">
                        <h4 class="text-lg font-semibold text-gray-900 mb-2">{{ property.title }}</h4>
                        <p class="text-gray-600">{% trans "Получите профессиональную консультацию по этому объекту недвижимости. Наш эксперт ответит на все ваши вопросы." %}</p>
                    </div>

                    <form id="consultationRequestForm" data-property-id="{{ property.id }}" class="space-y-4">
                        {% csrf_token %}
                        <input type="hidden" name="inquiry_type" value="consultation">

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">{% trans "Ваше имя" %} *</label>
                            <input type="text" name="name" required
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary focus:border-transparent">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">{% trans "Телефон" %} *</label>
                            <input type="tel" name="phone" required
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary focus:border-transparent">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">{% trans "Email" %}</label>
                            <input type="email" name="email"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary focus:border-transparent">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">{% trans "Что вас интересует?" %}</label>
                            <select name="consultation_topic"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary focus:border-transparent">
                                <option value="">{% trans "Выберите тему консультации" %}</option>
                                <option value="price">{% trans "Цена и условия покупки" %}</option>
                                <option value="investment">{% trans "Инвестиционный потенциал" %}</option>
                                <option value="documents">{% trans "Документы и оформление" %}</option>
                                <option value="area">{% trans "Район и инфраструктура" %}</option>
                                <option value="financing">{% trans "Финансирование покупки" %}</option>
                                <option value="rental">{% trans "Сдача в аренду" %}</option>
                                <option value="other">{% trans "Другое" %}</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">{% trans "Ваши вопросы" %}</label>
                            <textarea name="message" rows="4"
                                      class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary focus:border-transparent"
                                      placeholder="{% trans 'Опишите, что вас интересует об этом объекте...' %}"></textarea>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">{% trans "Предпочтительный способ связи" %}</label>
                            <div class="space-y-2">
                                <label class="flex items-center">
                                    <input type="radio" name="preferred_contact" value="phone"
                                           class="text-primary focus:ring-primary">
                                    <span class="ml-2 text-sm text-gray-700">{% trans "Телефонный звонок" %}</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="preferred_contact" value="whatsapp"
                                           class="text-primary focus:ring-primary">
                                    <span class="ml-2 text-sm text-gray-700">{% trans "WhatsApp" %}</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="preferred_contact" value="email"
                                           class="text-primary focus:ring-primary">
                                    <span class="ml-2 text-sm text-gray-700">{% trans "Email" %}</span>
                                </label>
                            </div>
                        </div>

                        <div class="flex space-x-3 pt-4">
                            <button type="submit"
                                    class="flex-1 bg-accent hover:bg-yellow-600 text-white font-bold py-3 px-6 rounded-lg transition-all duration-300 hover:scale-105 shadow-lg">
                                {% trans "Получить консультацию" %}
                            </button>
                            <button type="button" onclick="closeConsultationModal()"
                                    class="px-6 py-3 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors duration-200">
                                {% trans "Отмена" %}
                            </button>
                        </div>

                        <div id="consultation-message" class="hidden p-3 rounded-md text-sm"></div>
                    </form>

                    <!-- Alternative Contact Methods -->
                    <div class="mt-6 pt-6 border-t border-gray-200">
                        <p class="text-sm text-gray-600 mb-4">{% trans "Или свяжитесь с нами напрямую:" %}</p>
                        <div class="flex space-x-2">
                            <a href="tel:+6663303313"
                               class="flex-1 bg-primary hover:bg-blue-700 text-white text-center py-2 px-3 rounded-md transition-colors text-sm">
                                <i class="fas fa-phone mr-1"></i>{% trans "Позвонить" %}
                            </a>
                            <a href="https://wa.me/6663303313" target="_blank"
                               class="flex-1 bg-accent hover:bg-yellow-500 text-white text-center py-2 px-3 rounded-md transition-colors text-sm">
                                <i class="fab fa-whatsapp mr-1"></i>WhatsApp
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Callback Modal (Simple Call Request) -->
    <div id="callback-modal"
         class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden transition-opacity duration-300 backdrop-blur-sm">
        <div class="absolute inset-0 flex items-center justify-center p-4" onclick="event.stopPropagation()">
            <div class="relative bg-white rounded-xl shadow-2xl max-w-md w-full">
                <!-- Header -->
                <div class="flex justify-between items-center p-6 border-b border-gray-200">
                    <h3 class="text-xl font-bold text-gray-900">{% trans "Заказать звонок" %}</h3>
                    <button onclick="closeCallbackModal()"
                            class="text-gray-400 hover:text-gray-600 p-2 rounded-full hover:bg-gray-100 transition-colors duration-200">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>

                <!-- Body -->
                <div class="p-6">
                    <p class="text-gray-600 mb-6">{% trans "Оставьте свой номер телефона, и наш менеджер свяжется с вами в ближайшее время." %}</p>

                    <form id="callbackRequestForm" data-property-id="{{ property.id }}" class="space-y-4">
                        {% csrf_token %}
                        <input type="hidden" name="inquiry_type" value="callback">

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">{% trans "Ваше имя" %} *</label>
                            <input type="text" name="name" required
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-accent focus:border-transparent">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">{% trans "Телефон" %} *</label>
                            <input type="tel" name="phone" required
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-accent focus:border-transparent">
                        </div>

                        <div class="flex space-x-3 pt-4">
                            <button type="submit"
                                    class="flex-1 bg-accent hover:bg-yellow-600 text-white font-bold py-3 px-6 rounded transition-all duration-300 hover:scale-105 shadow-lg">
                                <i class="fas fa-phone mr-2"></i>
                                {% trans "Заказать звонок" %}
                            </button>
                            <button type="button" onclick="closeCallbackModal()"
                                    class="px-6 py-3 border border-gray-300 rounded text-gray-700 hover:bg-gray-50 transition-colors duration-200">
                                {% trans "Отмена" %}
                            </button>
                        </div>

                        <div id="callback-message" class="hidden p-3 rounded-md text-sm"></div>
                    </form>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/properties/detail.css' %}">
{% endblock %}

{% block extra_js %}
<!-- Property data and configuration -->
<script>
{% include 'properties/includes/detail_bootstrap.js.html' %}
window.propertyDetailTranslations = {
    priceOnRequest: "{{ _('Цена по запросу')|escapejs }}",
    perMonth: "{{ _('мес')|escapejs }}",
    perSqm: "{{ _('м²')|escapejs }}"
};
</script>

<!-- Property Detail Page Script -->
<script src="{% static 'js/properties/detail.js' %}"></script>
{% endblock %}
