{% extends 'base.html' %}
{% load static %}
{% load i18n %}
{% load currency_tags %}

{% block title %}{% trans "Недвижимость на Пхукете" %} - Undersun Estate{% endblock %}

{% block content %}
<!-- Compact Header Banner -->
<section class="bg-white border-b border-gray-200 pt-20 lg:pt-28">
    <div class="max-w-7xl mx-auto px-4 py-6">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center">
            <div>
                <h1 class="text-2xl lg:text-3xl font-bold text-primary mb-2">
                    {% if deal_type == 'sale' %}
                        {% trans "Недвижимость на продажу" %}
                    {% elif deal_type == 'rent' %}
                        {% trans "Недвижимость в аренду" %}
                    {% elif property_type %}
                        {{ property_type.name_display }}
                    {% else %}
                        {% trans "Каталог недвижимости" %}
                    {% endif %}
                </h1>
                <div class="flex items-center text-tertiary">
                    <i class="fas fa-map-marker-alt mr-2 text-accent"></i>
                    <span class="text-sm">{% trans "Пхукет, Таиланд" %}</span>
                </div>
            </div>
            
            <div class="mt-4 md:mt-0 flex items-center space-x-6 text-sm text-tertiary">
                <div class="flex items-center">
                    <span class="font-semibold text-primary">500+</span>
                    <span class="ml-1">{% trans "объектов" %}</span>
                </div>
                <div class="flex items-center">
                    <span class="font-semibold text-primary">15+</span>
                    <span class="ml-1">{% trans "районов" %}</span>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Main Content -->
<section class="py-8 bg-gray-50 min-h-screen">
    <div class="max-w-7xl mx-auto px-4">
        <!-- Mobile Filters Toggle -->
        <div class="lg:hidden mb-6">
            <button id="mobile-filters-toggle" class="w-full bg-white border border-gray-300 rounded-lg px-4 py-3 flex items-center justify-between shadow-sm hover:shadow-md transition-shadow">
                <div class="flex items-center">
                    <i class="fas fa-filter text-primary mr-3"></i>
                    <span class="font-medium text-gray-900">{% trans "Фильтры" %}</span>
                </div>
                <i class="fas fa-chevron-down text-gray-500 transition-transform duration-200" id="mobile-filters-arrow"></i>
            </button>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
            <!-- Filters Sidebar -->
            <div class="lg:col-span-1">
                <div id="filters-sidebar" class="bg-white rounded-lg shadow-md border border-gray-200 hidden lg:block">
                    <div class="bg-gray-50 px-6 py-4 border-b border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-900">
                            {% trans "Фильтры" %}
                        </h3>
                    </div>
                    
                    <form method="get" action="" id="filter-form" class="p-6">
                        <!-- Hidden sort field -->
                        <input type="hidden" name="sort" value="{{ request.GET.sort|default:'-created_at' }}">
                        
                        <!-- Deal Type -->
                        <div class="mb-6">
                            <h4 class="font-semibold text-gray-900 mb-3">
                                {% trans "Тип сделки" %}
                            </h4>
                            <div class="space-y-2">
                                <label class="flex items-center">
                                    <input type="radio" name="deal_type" value="" {% if not request.GET.deal_type %}checked{% endif %} class="w-4 h-4 text-accent border-gray-300 focus:ring-accent">
                                    <span class="ml-3 text-sm text-gray-700">{% trans "Все объекты" %}</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="deal_type" value="sale" {% if request.GET.deal_type == 'sale' %}checked{% endif %} class="w-4 h-4 text-accent border-gray-300 focus:ring-accent">
                                    <span class="ml-3 text-sm text-gray-700">{% trans "Продажа" %}</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="deal_type" value="rent" {% if request.GET.deal_type == 'rent' %}checked{% endif %} class="w-4 h-4 text-accent border-gray-300 focus:ring-accent">
                                    <span class="ml-3 text-sm text-gray-700">{% trans "Аренда" %}</span>
                                </label>
                            </div>
                        </div>
                        
                        <!-- Property Type -->
                        <div class="mb-6">
                            <h4 class="font-semibold text-gray-900 mb-3">
                                {% trans "Тип недвижимости" %}
                            </h4>
                            <div class="space-y-2">
                                {% for property_type in property_types %}
                                <label class="flex items-center">
                                    <input type="checkbox" name="property_type" value="{{ property_type.name }}" 
                                           {% if property_type.name in request.GET.property_type %}checked{% endif %} 
                                           class="w-4 h-4 text-primary border-gray-300 focus:ring-primary rounded">
                                    <span class="ml-3 text-sm text-gray-700">{{ property_type.name_display }}</span>
                                </label>
                                {% endfor %}
                            </div>
                        </div>
                        
                        <!-- Price Range -->
                        <div class="mb-6">
                            <h4 class="font-semibold text-gray-900 mb-3">
                                {% trans "Бюджет" %}, {{ selected_currency.code|default:'USD' }}
                            </h4>
                            <div class="space-y-3">
                                <div class="grid grid-cols-2 gap-2">
                                    <div class="relative">
                                        <input type="number" name="min_price" value="{{ request.GET.min_price }}" 
                                               placeholder="От" 
                                               class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:ring-2 focus:ring-primary focus:border-primary">
                                        <div class="price-loading-indicator hidden absolute right-2 top-1/2 transform -translate-y-1/2">
                                            <div class="w-4 h-4 border-2 border-primary border-t-transparent rounded-full animate-spin"></div>
                                        </div>
                                    </div>
                                    <div class="relative">
                                        <input type="number" name="max_price" value="{{ request.GET.max_price }}" 
                                               placeholder="До" 
                                               class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:ring-2 focus:ring-primary focus:border-primary">
                                        <div class="price-loading-indicator hidden absolute right-2 top-1/2 transform -translate-y-1/2">
                                            <div class="w-4 h-4 border-2 border-primary border-t-transparent rounded-full animate-spin"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="text-xs text-gray-500">
                                    {% trans "Укажите бюджет в" %} {{ selected_currency.code|default:'USD' }}
                                </div>
                            </div>
                        </div>
                        
                        <!-- Districts -->
                        <div class="mb-6">
                            <h4 class="font-semibold text-gray-900 mb-3">
                                {% trans "Район" %}
                            </h4>
                            <select name="district" id="district-select" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:ring-2 focus:ring-primary focus:border-primary">
                                <option value="">{% trans "Все районы" %}</option>
                                {% for district in districts %}
                                <option value="{{ district.slug }}" {% if request.GET.district == district.slug %}selected{% endif %}>
                                    {{ district.name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <!-- Locations -->
                        <div class="mb-6" id="location-filter">
                            <h4 class="font-semibold text-gray-900 mb-3">
                                {% trans "Локация" %}
                            </h4>
                            <select name="location" id="location-select" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:ring-2 focus:ring-primary focus:border-primary">
                                <option value="">{% trans "Все локации" %}</option>
                                {% for location in locations %}
                                <option value="{{ location.slug }}" {% if request.GET.location == location.slug %}selected{% endif %}>
                                    {{ location.name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <!-- Bedrooms -->
                        <div class="mb-6">
                            <h4 class="font-semibold text-gray-900 mb-3">
                                {% trans "Количество спален" %}
                            </h4>
                            <div class="space-y-2">
                                {% for i in "1234" %}
                                <label class="flex items-center">
                                    <input type="checkbox" name="bedrooms" value="{{ i }}" 
                                           {% if i in request.GET.bedrooms %}checked{% endif %} 
                                           class="w-4 h-4 text-primary border-gray-300 focus:ring-primary rounded">
                                    <span class="ml-3 text-sm text-gray-700">{{ i }}{% if i == "4" %}+{% endif %} {% trans "спальня" %}</span>
                                </label>
                                {% endfor %}
                            </div>
                        </div>
                        
                        <!-- Amenities -->
                        <div class="mb-6">
                            <h4 class="font-semibold text-gray-900 mb-3">
                                {% trans "Удобства" %}
                            </h4>
                            <div class="space-y-2">
                                {% for amenity in amenities %}
                                <label class="flex items-center">
                                    <input type="checkbox" name="amenities" value="{{ amenity.id }}" 
                                           {% if amenity.id|stringformat:"s" in current_filters.amenities %}checked{% endif %} 
                                           class="w-4 h-4 text-primary border-gray-300 focus:ring-primary rounded">
                                    <span class="ml-3 text-sm text-gray-700 flex items-center">
                                        {% if amenity.icon %}
                                            <i class="{{ amenity.icon }} mr-2 text-accent"></i>
                                        {% endif %}
                                        {{ amenity.name }}
                                    </span>
                                </label>
                                {% endfor %}
                            </div>
                        </div>
                        
                        <!-- Filter Actions -->
                        <div class="border-t border-gray-200 pt-4 mt-4">
                            <div class="space-y-2">
                                <button type="submit" class="w-full bg-primary hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-md transition-colors">
                                    {% trans "Применить" %}
                                </button>
                                <a href="{% url 'properties:property_list' %}" class="w-full text-center bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium py-2 px-4 rounded-md transition-colors block">
                                    {% trans "Очистить" %}
                                </a>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Properties Grid -->
            <div class="lg:col-span-3 properties-container">
                <!-- Sort & Results Count -->
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6">
                    <div class="mb-4 sm:mb-0">
                        <h2 class="text-xl font-semibold text-gray-900 results-count" data-heading-tag="H2" data-total-count="{% if properties %}{% if is_paginated %}{{ paginator.count }}{% else %}{{ properties|length }}{% endif %}{% else %}0{% endif %}">
                            {% if properties %}
                                {% if is_paginated %}
                                    {% blocktrans count counter=paginator.count %}
                                        Найден {{ counter }} объект
                                    {% plural %}
                                        Найдено {{ counter }} объектов
                                    {% endblocktrans %}
                                {% else %}
                                    {% blocktrans count counter=properties|length %}
                                        Найден {{ counter }} объект
                                    {% plural %}
                                        Найдено {{ counter }} объектов
                                    {% endblocktrans %}
                                {% endif %}
                            {% else %}
                                {% trans "Объекты не найдены" %}
                            {% endif %}
                        </h2>
                    </div>
                    
                    {% if properties %}
                    <div class="flex items-center space-x-4">
                        <span class="text-sm text-gray-600">{% trans "Сортировка:" %}</span>
                        <select onchange="updateSort(this.value)" class="px-3 py-1 border border-gray-300 rounded-md text-sm focus:ring-2 focus:ring-accent focus:border-accent">
                            <option value="-created_at" {% if request.GET.sort == '-created_at' %}selected{% endif %}>{% trans "По дате" %}</option>
                            <option value="price_sale_usd" {% if request.GET.sort == 'price_sale_usd' %}selected{% endif %}>{% trans "Цена ↑" %}</option>
                            <option value="-price_sale_usd" {% if request.GET.sort == '-price_sale_usd' %}selected{% endif %}>{% trans "Цена ↓" %}</option>
                            <option value="-area_total" {% if request.GET.sort == '-area_total' %}selected{% endif %}>{% trans "Площадь ↓" %}</option>
                        </select>
                        
                        <div class="flex border border-gray-300 rounded-md">
                            <button onclick="setView('grid')" id="grid-view" class="p-2 text-gray-600 hover:text-primary border-r border-gray-300" title="{% trans 'Сетка' %}">
                                <i class="fas fa-th-large"></i>
                            </button>
                            <button onclick="setView('map')" id="map-view" class="p-2 text-gray-600 hover:text-primary" title="{% trans 'Карта' %}">
                                <i class="fas fa-map-marker-alt"></i>
                            </button>
                        </div>
                    </div>
                    {% endif %}
                </div>
                
                {% if properties %}
                    <!-- Properties Grid -->
                    <div id="properties-grid" class="properties-grid grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
                        {% for property in properties %}
                            {% include 'properties/card.html' %}
                        {% endfor %}
                    </div>
                    
                    <!-- Properties Map -->
                    <div id="properties-map" class="hidden w-full h-[600px] bg-white rounded-lg shadow-md border border-gray-200 overflow-hidden">
                        <div id="map-container" class="w-full h-full"></div>
                    </div>
                    
                    <!-- Pagination -->
                    {% if is_paginated %}
                        <div class="pagination-container flex justify-center mt-12">
                            <nav class="flex items-center space-x-2">
                                {% if page_obj.has_previous %}
                                    <a href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page=1" class="px-3 py-2 text-sm font-medium text-gray-500 hover:text-primary border border-gray-300 rounded-md hover:border-primary transition-colors hover:bg-primary/10">
                                        {% trans "Первая" %}
                                    </a>
                                    <a href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.previous_page_number }}" class="px-3 py-2 text-sm font-medium text-gray-500 hover:text-primary border border-gray-300 rounded-md hover:border-primary transition-colors hover:bg-primary/10">
                                        {% trans "‹ Пред" %}
                                    </a>
                                {% endif %}
                                
                                {% for num in page_obj.paginator.page_range %}
                                    {% if page_obj.number == num %}
                                        <span class="px-3 py-2 text-sm font-medium text-white bg-primary border border-primary rounded-md">
                                            {{ num }}
                                        </span>
                                    {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                                        <a href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ num }}" class="px-3 py-2 text-sm font-medium text-gray-500 hover:text-primary border border-gray-300 rounded-md hover:border-primary transition-colors hover:bg-primary/10">
                                            {{ num }}
                                        </a>
                                    {% endif %}
                                {% endfor %}
                                
                                {% if page_obj.has_next %}
                                    <a href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.next_page_number }}" class="px-3 py-2 text-sm font-medium text-gray-500 hover:text-primary border border-gray-300 rounded-md hover:border-primary transition-colors hover:bg-primary/10">
                                        {% trans "След ›" %}
                                    </a>
                                    <a href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.paginator.num_pages }}" class="px-3 py-2 text-sm font-medium text-gray-500 hover:text-primary border border-gray-300 rounded-md hover:border-primary transition-colors hover:bg-primary/10">
                                        {% trans "Последняя" %}
                                    </a>
                                {% endif %}
                            </nav>
                        </div>
                    {% endif %}
                    
                {% else %}
                    <!-- No Results -->
                    <div class="no-results text-center py-12">
                        <div class="text-gray-400 text-6xl mb-4">
                            <i class="fas fa-home"></i>
                        </div>
                        <h3 class="text-xl font-semibold text-gray-900 mb-2">{% trans "Объекты не найдены" %}</h3>
                        <p class="text-gray-600 mb-6">{% trans "Попробуйте изменить параметры поиска или сбросить фильтры" %}</p>
                        <a href="{% url 'properties:property_list' %}" class="bg-primary hover:bg-blue-700 text-white font-medium py-2 px-6 rounded-md transition-colors">
                            {% trans "Сбросить фильтры" %}
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_css %}
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
<style>
/* Loading Animation */
.properties-container.loading {
    @apply relative;
}

.loading-overlay {
    @apply absolute inset-0 bg-white bg-opacity-75 flex items-center justify-center z-10 rounded-lg;
}

.spinner {
    @apply w-8 h-8 border-4 border-primary border-t-transparent rounded-full animate-spin;
}

/* Mobile Filters */
#filters-sidebar.mobile-open {
    @apply block;
}

/* Smooth Transitions */
.properties-grid .property-card {
    @apply transition-all duration-300 hover:transform hover:scale-105;
}

/* View Toggle */
.view-toggle button.active {
    @apply bg-primary text-white;
}

/* Custom Checkbox and Radio Styles */
input[type="checkbox"]:checked,
input[type="radio"]:checked {
    @apply bg-primary border-primary;
}

input[type="checkbox"]:focus,
input[type="radio"]:focus {
    @apply ring-2 ring-primary ring-opacity-50;
}

/* Responsive Filters */
@media (max-width: 1024px) {
    #filters-sidebar {
        @apply max-h-96 overflow-y-auto;
    }
}

/* Pagination Styles */
.pagination-container {
    @apply flex justify-center mt-12;
}

.pagination-container nav {
    @apply flex items-center space-x-2;
}

.pagination-container a {
    @apply px-3 py-2 text-sm font-medium text-gray-500 hover:text-primary border border-gray-300 rounded-md hover:border-primary transition-colors cursor-pointer;
}

.pagination-container a:hover {
    @apply bg-primary/10;
}

.pagination-container span {
    @apply px-3 py-2 text-sm font-medium text-white bg-primary border border-primary rounded-md;
}

/* Ensure pagination is visible */
.pagination-container .disabled {
    @apply text-gray-400 cursor-not-allowed;
}

/* Map Container Z-Index Fix */
#properties-map {
    position: relative;
    z-index: 1 !important;
}

.leaflet-container {
    z-index: 1 !important;
}

.leaflet-map-pane {
    z-index: 1 !important;
}

.leaflet-tile-pane {
    z-index: 1 !important;
}

.leaflet-objects-pane {
    z-index: 2 !important;
}

.leaflet-marker-pane {
    z-index: 3 !important;
}

.leaflet-popup-pane {
    z-index: 4 !important;
}

.leaflet-control-container {
    z-index: 5 !important;
}

/* Custom Marker Styles */
.property-marker-wrapper {
    background: none !important;
    border: none !important;
}

.property-marker-container {
    position: relative;
    display: flex;
    flex-direction: column;
    align-items: center;
    transition: all 0.2s ease;
}

.property-marker-container:hover {
    transform: scale(1.05);
}

.custom-marker {
    position: relative;
    transition: all 0.2s ease;
    filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
}

.custom-marker:hover {
    transform: scale(1.1);
    filter: drop-shadow(0 4px 8px rgba(0,0,0,0.3));
}

.custom-marker svg {
    display: block;
}

/* Enhanced Popup Styles */
.leaflet-popup-content-wrapper {
    border-radius: 12px !important;
    box-shadow: 0 20px 50px rgba(0, 0, 0, 0.15) !important;
    border: none !important;
    background: white !important;
    overflow: hidden !important;
    padding: 0 !important;
    max-width: 300px !important;
    width: 300px !important;
    max-height: 500px !important;
}

.leaflet-popup {
    margin-bottom: 20px !important;
}

/* Ensure popup stays within map bounds */
.leaflet-popup-close-button {
    color: #474B57 !important;
    font-size: 18px !important;
    font-weight: bold !important;
    padding: 4px 8px !important;
}

.leaflet-popup-content {
    margin: 0 !important;
    padding: 0 !important;
    width: 300px !important;
}

.leaflet-popup-tip {
    background: white !important;
    box-shadow: 0 3px 14px rgba(0, 0, 0, 0.1) !important;
}

.property-popup {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    width: 300px;
    background: white;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 20px 50px rgba(0, 0, 0, 0.15);
    border: 1px solid rgba(255, 255, 255, 0.2);
}

.popup-image-container {
    position: relative;
    width: 100%;
    height: 120px;
    overflow: hidden;
    background: linear-gradient(45deg, #f0f0f0, #e0e0e0);
}

.popup-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    object-position: center;
    display: block;
    transition: transform 0.3s ease;
}

.popup-image:hover {
    transform: scale(1.02);
}

.image-carousel-nav {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    background: rgba(255, 255, 255, 0.9);
    border: none;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 14px;
    color: #474B57;
    transition: all 0.2s ease;
    backdrop-filter: blur(10px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.image-carousel-nav:hover {
    background: rgba(255, 255, 255, 1);
    transform: translateY(-50%) scale(1.1);
    color: #F1B400;
}

.image-carousel-nav.prev {
    left: 8px;
}

.image-carousel-nav.next {
    right: 8px;
}

.image-indicators {
    position: absolute;
    bottom: 12px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: 6px;
}

.image-indicator {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.5);
    cursor: pointer;
    transition: all 0.2s ease;
}

.image-indicator.active {
    background: #F1B400;
    box-shadow: 0 0 0 2px rgba(241, 180, 0, 0.3);
}

/* Content Area */
.popup-content {
    padding: 16px;
    background: white;
}

.popup-title {
    font-weight: 700;
    font-size: 16px;
    color: #474B57;
    margin-bottom: 8px;
    line-height: 1.4;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.popup-price {
    color: #F1B400;
    font-weight: 800;
    font-size: 18px;
    margin-bottom: 12px;
    text-shadow: 0 1px 2px rgba(241, 180, 0, 0.1);
}

.popup-location {
    display: flex;
    align-items: center;
    color: #616677;
    font-size: 13px;
    margin-bottom: 12px;
}

.popup-location i {
    color: #F1B400;
    margin-right: 6px;
    font-size: 12px;
}

/* Property Details Grid */
.popup-details-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
    margin-bottom: 16px;
}

.popup-detail-item {
    display: flex;
    align-items: center;
    font-size: 12px;
    color: #616677;
    background: rgba(71, 75, 87, 0.05);
    padding: 6px 8px;
    border-radius: 6px;
    border: 1px solid rgba(71, 75, 87, 0.1);
}

.popup-detail-item i {
    color: #F1B400;
    margin-right: 6px;
    font-size: 11px;
    min-width: 12px;
}

/* Agent Info */
.popup-agent {
    background: linear-gradient(135deg, #474B57 0%, #616677 100%);
    color: white;
    padding: 10px 16px;
    margin: -16px -16px 14px -16px;
    border-bottom: 3px solid #F1B400;
}

.popup-agent-name {
    font-weight: 600;
    font-size: 13px;
    margin-bottom: 2px;
}

.popup-agent-title {
    font-size: 11px;
    opacity: 0.8;
}

/* Action Buttons */
.popup-actions {
    display: flex;
    gap: 8px;
}

.popup-button {
    flex: 1;
    padding: 10px 12px;
    border-radius: 8px;
    text-decoration: none;
    font-size: 12px;
    font-weight: 600;
    text-align: center;
    transition: all 0.3s ease;
    border: none;
    cursor: pointer;
    position: relative;
    overflow: hidden;
}

.popup-button::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
    transition: left 0.5s;
}

.popup-button:hover::before {
    left: 100%;
}

.popup-button-primary {
    background: linear-gradient(135deg, #474B57 0%, #616677 100%);
    color: white;
    box-shadow: 0 4px 15px rgba(71, 75, 87, 0.3);
}

.popup-button-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(71, 75, 87, 0.4);
    color: white;
}

.popup-button-secondary {
    background: linear-gradient(135deg, #F1B400 0%, #e6a300 100%);
    color: white;
    box-shadow: 0 4px 15px rgba(241, 180, 0, 0.3);
}

.popup-button-secondary:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(241, 180, 0, 0.4);
    color: white;
}

.popup-button-icon {
    background: rgba(241, 180, 0, 0.1);
    color: #F1B400;
    border: 2px solid rgba(241, 180, 0, 0.2);
    width: 36px;
    height: 36px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
}

.popup-button-icon:hover {
    background: #F1B400;
    color: white;
    transform: translateY(-2px) scale(1.1);
    box-shadow: 0 8px 25px rgba(241, 180, 0, 0.4);
}

/* Price Indicator Styles (like Booking.com) */
.price-indicator {
    position: relative;
    background: #10b981;
    color: white;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 600;
    white-space: nowrap;
    margin-bottom: 2px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    border: 2px solid white;
    transition: all 0.2s ease;
}

.price-indicator:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}

.price-text {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    font-size: 11px;
    font-weight: 700;
    letter-spacing: 0.5px;
}

.price-arrow {
    position: absolute;
    bottom: -6px;
    left: 50%;
    transform: translateX(-50%);
    width: 0;
    height: 0;
    border-left: 6px solid transparent;
    border-right: 6px solid transparent;
    border-top: 6px solid inherit;
}

.price-arrow::before {
    content: '';
    position: absolute;
    bottom: 2px;
    left: -4px;
    width: 0;
    height: 0;
    border-left: 4px solid transparent;
    border-right: 4px solid transparent;
    border-top: 4px solid white;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .price-indicator {
        font-size: 10px;
        padding: 3px 6px;
    }
    
    .price-text {
        font-size: 9px;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<!-- Leaflet JavaScript -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>
<script>
// Price presets function
function setPriceRange(min, max) {
    const minInput = document.querySelector('input[name="min_price"]');
    const maxInput = document.querySelector('input[name="max_price"]');
    
    if (minInput) minInput.value = min || '';
    if (maxInput) maxInput.value = max || '';
    
    // Trigger filter update
    if (typeof updatePropertyFilters === 'function') {
        updatePropertyFilters();
    }
}

function updateSort(value) {
    // Update sort field in form
    const form = document.getElementById('filter-form');
    const sortInput = form.querySelector('input[name="sort"]');
    
    if (sortInput) {
        sortInput.value = value;
    }
    
    // Submit the form directly
    form.submit();
}

// Global map variable
let propertiesMap = null;
let markersGroup = null;

// Function to get marker color based on deal type
function getMarkerColor(dealType) {
    switch(dealType) {
        case 'sale': return '#10b981'; // green
        case 'rent': return '#3b82f6'; // blue
        case 'both': return '#8b5cf6'; // purple
        default: return '#6b7280'; // gray
    }
}

// Function to get property type icon SVG content
function getPropertyIconSVG(propertyType) {
    const iconSVGs = {
        'villa': `
            <g transform="translate(6, 6)">
                <path d="M10 4L2 10h2v8h12v-8h2L10 4z" fill="white"/>
                <rect x="4" y="10" width="12" height="8" fill="white"/>
                <rect x="8.5" y="14" width="3" height="4" fill="currentColor"/>
                <rect x="5.5" y="12" width="2" height="2" fill="currentColor"/>
                <rect x="12.5" y="12" width="2" height="2" fill="currentColor"/>
                <rect x="13" y="6" width="1.5" height="4" fill="white"/>
            </g>
        `,
        'apartment': `
            <g transform="translate(6, 4)">
                <rect x="2" y="4" width="16" height="16" fill="white"/>
                <polygon points="1,4 10,1 19,4" fill="white"/>
                <rect x="4" y="7" width="2" height="2" fill="currentColor"/>
                <rect x="7" y="7" width="2" height="2" fill="currentColor"/>
                <rect x="11" y="7" width="2" height="2" fill="currentColor"/>
                <rect x="14" y="7" width="2" height="2" fill="currentColor"/>
                <rect x="4" y="11" width="2" height="2" fill="currentColor"/>
                <rect x="7" y="11" width="2" height="2" fill="currentColor"/>
                <rect x="11" y="11" width="2" height="2" fill="currentColor"/>
                <rect x="14" y="11" width="2" height="2" fill="currentColor"/>
                <rect x="4" y="15" width="2" height="2" fill="currentColor"/>
                <rect x="14" y="15" width="2" height="2" fill="currentColor"/>
                <rect x="8" y="15" width="4" height="5" fill="currentColor"/>
            </g>
        `,
        'condominium': `
            <g transform="translate(6, 4)">
                <rect x="2" y="4" width="16" height="16" fill="white"/>
                <polygon points="1,4 10,1 19,4" fill="white"/>
                <rect x="4" y="7" width="2" height="2" fill="currentColor"/>
                <rect x="7" y="7" width="2" height="2" fill="currentColor"/>
                <rect x="11" y="7" width="2" height="2" fill="currentColor"/>
                <rect x="14" y="7" width="2" height="2" fill="currentColor"/>
                <rect x="4" y="11" width="2" height="2" fill="currentColor"/>
                <rect x="7" y="11" width="2" height="2" fill="currentColor"/>
                <rect x="11" y="11" width="2" height="2" fill="currentColor"/>
                <rect x="14" y="11" width="2" height="2" fill="currentColor"/>
                <rect x="4" y="15" width="2" height="2" fill="currentColor"/>
                <rect x="14" y="15" width="2" height="2" fill="currentColor"/>
                <rect x="8" y="15" width="4" height="5" fill="currentColor"/>
            </g>
        `,
        'townhouse': `
            <g transform="translate(4, 5)">
                <rect x="0" y="8" width="7" height="10" fill="white"/>
                <polygon points="0,8 3.5,4 7,8" fill="white"/>
                <rect x="6" y="6" width="7" height="12" fill="white"/>
                <polygon points="6,6 9.5,2 13,6" fill="white"/>
                <rect x="12" y="9" width="7" height="9" fill="white"/>
                <polygon points="12,9 15.5,5 19,9" fill="white"/>
                <rect x="2" y="14" width="2" height="4" fill="currentColor"/>
                <rect x="8" y="14" width="2" height="4" fill="currentColor"/>
                <rect x="14" y="14" width="2" height="4" fill="currentColor"/>
                <rect x="1" y="11" width="1.5" height="1.5" fill="currentColor"/>
                <rect x="4.5" y="11" width="1.5" height="1.5" fill="currentColor"/>
                <rect x="7" y="9" width="1.5" height="1.5" fill="currentColor"/>
                <rect x="10.5" y="9" width="1.5" height="1.5" fill="currentColor"/>
                <rect x="13" y="12" width="1.5" height="1.5" fill="currentColor"/>
                <rect x="16.5" y="12" width="1.5" height="1.5" fill="currentColor"/>
            </g>
        `,
        'land': `
            <g transform="translate(5, 6)">
                <rect x="1" y="2" width="18" height="14" fill="none" stroke="white" stroke-width="1.5" stroke-dasharray="2,1"/>
                <circle cx="6" cy="8" r="3" fill="white"/>
                <rect x="5.5" y="11" width="1" height="3" fill="white"/>
                <circle cx="14" cy="6" r="2.5" fill="white"/>
                <rect x="13.5" y="8.5" width="1" height="2.5" fill="white"/>
                <circle cx="4" cy="13" r="1.5" fill="white"/>
                <circle cx="16" cy="12" r="1.5" fill="white"/>
                <circle cx="2" cy="3" r="1" fill="white"/>
                <circle cx="18" cy="3" r="1" fill="white"/>
                <circle cx="2" cy="15" r="1" fill="white"/>
                <circle cx="18" cy="15" r="1" fill="white"/>
            </g>
        `,
        'business': `
            <g transform="translate(6, 5)">
                <rect x="2" y="6" width="16" height="12" fill="white"/>
                <polygon points="1,6 10,3 19,6" fill="white"/>
                <rect x="3" y="14" width="6" height="4" fill="currentColor"/>
                <rect x="11" y="14" width="6" height="4" fill="currentColor"/>
                <rect x="4" y="9" width="2" height="2" fill="currentColor"/>
                <rect x="7" y="9" width="2" height="2" fill="currentColor"/>
                <rect x="11" y="9" width="2" height="2" fill="currentColor"/>
                <rect x="14" y="9" width="2" height="2" fill="currentColor"/>
                <rect x="3" y="12" width="14" height="1" fill="white"/>
                <rect x="9" y="15" width="2" height="3" fill="white"/>
            </g>
        `
    };
    
    return iconSVGs[propertyType.toLowerCase()] || `
        <g transform="translate(7, 6)">
            <rect x="2" y="10" width="14" height="10" fill="white"/>
            <polygon points="1,10 9,4 17,10" fill="white"/>
            <rect x="7" y="15" width="4" height="5" fill="currentColor"/>
            <rect x="4" y="13" width="2.5" height="2" fill="currentColor"/>
            <rect x="11.5" y="13" width="2.5" height="2" fill="currentColor"/>
        </g>
    `;
}

// Function to format price for marker display
function formatPriceForMarker(priceText) {
    if (!priceText || priceText === 'По запросу' || priceText === 'Price on request') {
        return null;
    }
    
    // Extract price and currency from formatted text
    // Expected formats: "$1,500,000", "฿45,000,000", "₽85,000,000", etc.
    const match = priceText.match(/([₽$฿€£¥])?([\d,\s]+)([₽$฿€£¥])?/);
    if (!match) return null;
    
    const currencyStart = match[1];
    const priceStr = match[2];
    const currencyEnd = match[3];
    const currency = currencyStart || currencyEnd || '$';
    
    // Convert to number
    const price = parseInt(priceStr.replace(/[,\s]/g, ''));
    if (isNaN(price) || price <= 0) return null;
    
    // Format for display
    if (price >= 1000000) {
        return `${currency}${(price / 1000000).toFixed(1)}M`;
    } else if (price >= 1000) {
        return `${currency}${Math.round(price / 1000)}K`;
    } else {
        return `${currency}${price}`;
    }
}

// Function to create custom marker
function createCustomMarker(lat, lng, propertyType, dealType, priceText = null) {
    const markerColor = getMarkerColor(dealType);
    const priceDisplay = formatPriceForMarker(priceText);
    
    // Create custom icon with price indicator
    const customIcon = L.divIcon({
        html: `
            <div class="property-marker-container">
                <!-- Price indicator (like Booking.com) -->
                ${priceDisplay ? `
                <div class="price-indicator" style="background: ${markerColor};">
                    <span class="price-text">${priceDisplay}</span>
                    <div class="price-arrow"></div>
                </div>
                ` : ''}
                
                <!-- Property icon marker -->
                <div class="custom-marker" style="color: ${markerColor};">
                    <svg width="32" height="40" viewBox="0 0 32 40" xmlns="http://www.w3.org/2000/svg">
                        <path d="M16 0C7.16 0 0 7.16 0 16c0 12 16 24 16 24s16-12 16-24C32 7.16 24.84 0 16 0z" fill="${markerColor}"/>
                        ${getPropertyIconSVG(propertyType)}
                    </svg>
                </div>
            </div>
        `,
        className: 'property-marker-wrapper',
        iconSize: [140, 60], // Увеличиваем размер для размещения цены
        iconAnchor: [70, 60], // Центрируем по горизонтали, привязка к низу
        popupAnchor: [0, -60]
    });
    
    return L.marker([lat, lng], { icon: customIcon });
}

function setView(viewType) {
    // Update button states
    document.querySelectorAll('#grid-view, #map-view').forEach(btn => {
        btn.classList.remove('text-primary', 'bg-primary/10');
        btn.classList.add('text-gray-600');
    });
    
    const activeBtn = document.getElementById(viewType + '-view');
    activeBtn.classList.add('text-primary', 'bg-primary/10');
    activeBtn.classList.remove('text-gray-600');
    
    // Show/hide views
    const grid = document.getElementById('properties-grid');
    const map = document.getElementById('properties-map');
    const pagination = document.querySelector('.pagination-container');
    
    if (viewType === 'map') {
        // Hide grid and pagination, show map
        grid.classList.add('hidden');
        if (pagination) pagination.classList.add('hidden');
        map.classList.remove('hidden');
        
        // Initialize map if not already done
        initializePropertiesMap();
    } else {
        // Show grid and pagination, hide map
        grid.classList.remove('hidden');
        if (pagination) pagination.classList.remove('hidden');
        map.classList.add('hidden');
        
        // Set grid layout
        grid.className = 'properties-grid grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6';
    }
    
    // Save preference
    localStorage.setItem('propertyViewType', viewType);
}

// Initialize Properties Map
function initializePropertiesMap() {
    if (propertiesMap) {
        // Map already exists, just refresh markers
        updateMapMarkers();
        return;
    }
    
    const mapContainer = document.getElementById('map-container');
    if (!mapContainer) return;
    
    // Initialize map centered on Phuket
    propertiesMap = L.map('map-container').setView([7.9519, 98.3381], 11);
    
    // Add tile layer
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
    }).addTo(propertiesMap);
    
    // Create marker group
    markersGroup = L.layerGroup().addTo(propertiesMap);
    
    // Add markers for properties
    updateMapMarkers();
    
    // Force map resize after container is visible
    setTimeout(() => {
        propertiesMap.invalidateSize();
    }, 100);
}

// Update results counter 
function updateResultsCounter() {
    const resultsCountElement = document.querySelector('.results-count');
    if (!resultsCountElement) return;
    
    // Get total count from data attribute (server-provided total count)
    const totalCount = parseInt(resultsCountElement.dataset.totalCount) || 0;
    
    // Update counter text with proper Russian pluralization
    let counterText;
    if (totalCount === 0) {
        counterText = 'Объекты не найдены';
    } else if (totalCount === 1) {
        counterText = 'Найден 1 объект';
    } else if (totalCount >= 2 && totalCount <= 4) {
        counterText = `Найдено ${totalCount} объекта`;
    } else {
        counterText = `Найдено ${totalCount} объектов`;
    }
    
    resultsCountElement.textContent = counterText;
    console.log(`Updated results counter: ${totalCount} total properties found (${document.querySelectorAll('.property-card').length} on current page)`);
}

// Update map markers based on all filtered properties (optimized loading)
function updateMapMarkers() {
    if (!markersGroup) return;
    
    // Clear existing markers
    markersGroup.clearLayers();
    
    console.log('Loading all filtered properties for map view...');
    
    // Get current filter parameters
    const form = document.getElementById('filter-form');
    const formData = new FormData(form);
    const params = new URLSearchParams();
    
    // Convert FormData to URLSearchParams
    for (const [key, value] of formData.entries()) {
        if (typeof value === 'string') {
            params.append(key, value);
        }
    }
    
    // Fetch all filtered properties via optimized JSON API
    fetch(`{% url 'properties:map_properties_json' %}?${params.toString()}`)
        .then(response => response.json())
        .then(data => {
            if (!data.success) {
                console.error('Error loading map properties:', data.error);
                // Fallback to current page properties
                loadCurrentPageProperties();
                return;
            }
            
            const properties = data.properties;
            const bounds = [];
            
            console.log(`Loaded ${properties.length} total filtered properties for map`);
            
            properties.forEach((property, index) => {
                const lat = property.lat;
                const lng = property.lng;
                
                if (!lat || !lng || isNaN(lat) || isNaN(lng)) {
                    return; // Skip if no valid coordinates
                }
                
                // Apply small jitter for overlapping coordinates
                let adjustedLat = lat;
                let adjustedLng = lng;
                
                if (lat % 1 === 0 && lng % 1 === 0) {
                    const jitter = 0.001;
                    adjustedLat = lat + (Math.random() - 0.5) * jitter;
                    adjustedLng = lng + (Math.random() - 0.5) * jitter;
                }
                
                // Create marker with property data
                const marker = createCustomMarker(
                    adjustedLat, 
                    adjustedLng, 
                    property.property_type, 
                    property.deal_type, 
                    property.price
                ).addTo(markersGroup);
                
                // Create popup content with real image data
                const imageUrl = property.image_url || '{% static "images/no-image.svg" %}';
                const popupContent = `
                    <div class="property-popup">
                        <!-- Main Image -->
                        <div class="popup-image-container">
                            <img src="${imageUrl}" alt="${property.title}" class="popup-image" />
                        </div>
                        
                        <!-- Content -->
                        <div class="popup-content">
                            <!-- Title and Price -->
                            <div class="popup-title">${property.title}</div>
                            <div class="popup-price">${property.price}</div>
                            
                            <!-- Location -->
                            <div class="popup-location">
                                <i class="fas fa-map-marker-alt"></i>
                                ${property.location}
                            </div>
                            
                            <!-- Property Details Grid -->
                            <div class="popup-details-grid">
                                <div class="popup-detail-item">
                                    <i class="fas fa-home"></i>
                                    <span>${property.property_type}</span>
                                </div>
                                <div class="popup-detail-item">
                                    <i class="fas fa-tag"></i>
                                    <span>${property.deal_type}</span>
                                </div>
                            </div>
                            
                            <!-- Action Buttons -->
                            <div class="popup-actions">
                                <button class="popup-button-icon" onclick="toggleFavorite(${property.id})" title="{% trans 'В избранное' %}">
                                    <i class="far fa-heart" id="favorite-${property.id}"></i>
                                </button>
                                
                                <a href="https://wa.me/66123456789?text={% trans 'Здравствуйте! Меня интересует объект' %}: ${encodeURIComponent(property.title)}" 
                                   class="popup-button popup-button-secondary" 
                                   target="_blank">
                                    <i class="fab fa-whatsapp"></i> WhatsApp
                                </a>
                                
                                <a href="${property.url}" class="popup-button popup-button-primary">
                                    {% trans "Подробнее" %}
                                </a>
                            </div>
                        </div>
                    </div>
                `;
                
                marker.bindPopup(popupContent, {
                    maxWidth: 280,
                    className: 'enhanced-popup',
                    autoPan: true,
                    autoPanPadding: [20, 20],
                    keepInView: true,
                    closeButton: true
                });
                
                bounds.push([adjustedLat, adjustedLng]);
            });
            
            console.log(`Total markers added: ${bounds.length}`);
            
            // Fit map to bounds if we have markers
            if (bounds.length > 0) {
                const group = new L.featureGroup(markersGroup.getLayers());
                propertiesMap.fitBounds(group.getBounds().pad(0.1));
            } else {
                console.log('No markers to display - keeping default Phuket view');
            }
        })
        .catch(error => {
            console.error('Error fetching map properties:', error);
            // Fallback to current page properties
            loadCurrentPageProperties();
        });
}

// Fallback function to load current page properties
function loadCurrentPageProperties() {
    console.log('Loading current page properties as fallback...');
    const propertyCards = document.querySelectorAll('.property-card');
    const bounds = [];
    
    propertyCards.forEach((card, index) => {
        // Extract property data from card attributes
        const propertyId = card.dataset.propertyId;
        let lat = parseFloat(card.dataset.latitude);
        let lng = parseFloat(card.dataset.longitude);
        
        // Handle potential comma-separated decimals (localization issue)
        if (isNaN(lat) || isNaN(lng)) {
            lat = parseFloat(card.dataset.latitude.replace(',', '.'));
            lng = parseFloat(card.dataset.longitude.replace(',', '.'));
        }
        
        console.log(`Property ${index + 1}: ID=${propertyId}`);
        console.log(`  - Raw data: lat="${card.dataset.latitude}", lng="${card.dataset.longitude}"`);
        console.log(`  - Parsed: lat=${lat}, lng=${lng}`);
        
        if (!lat || !lng || isNaN(lat) || isNaN(lng)) {
            console.log(`Skipping property ${propertyId} - no valid coordinates (lat=${card.dataset.latitude}, lng=${card.dataset.longitude})`);
            return; // Skip if no coordinates
        }
        
        // Get property details from data attributes and elements
        const title = card.dataset.title || 'Property';
        const propertyType = card.dataset.propertyType || '';
        const dealType = card.dataset.dealType || '';
        const location = card.dataset.location || '';
        const link = card.dataset.url || '#';
        const mainImage = card.dataset.mainImage || '/media/no-image.jpg';
        const imagesString = card.dataset.images || '';
        const images = imagesString ? imagesString.split(',').filter(img => img.trim()) : [mainImage];
        const bedrooms = card.dataset.bedrooms || '';
        const bathrooms = card.dataset.bathrooms || '';
        const area = card.dataset.area || '';
        
        // Get current price from price element (respects currency conversion)
        const priceElement = card.querySelector(`[class*="card-price-${propertyId}"]`);
        const price = priceElement ? priceElement.textContent.trim() : '';
        
        // Get current currency
        const currencyElement = card.querySelector(`[class*="current-currency-code-${propertyId}"]`);
        const currency = currencyElement ? currencyElement.textContent.trim() : '';
        
        const formattedPrice = price && currency ? `${price} ${currency}` : price;
        
        // Check if coordinates are too simplified and add small jitter to avoid overlapping
        let adjustedLat = lat;
        let adjustedLng = lng;
        
        // If coordinates are whole numbers (like 7, 8, 98), they're likely simplified
        if (lat % 1 === 0 && lng % 1 === 0) {
            // Add small random offset to prevent markers from stacking
            const jitter = 0.001; // ~100 meters
            adjustedLat = lat + (Math.random() - 0.5) * jitter;
            adjustedLng = lng + (Math.random() - 0.5) * jitter;
            console.log(`Applied jitter to property ${propertyId}: [${lat}, ${lng}] -> [${adjustedLat.toFixed(6)}, ${adjustedLng.toFixed(6)}]`);
        }
        
        console.log(`Adding marker for property ${propertyId}: ${title} at [${adjustedLat}, ${adjustedLng}]`);
        
        // Create marker with adjusted coordinates using custom marker (include price)
        const marker = createCustomMarker(adjustedLat, adjustedLng, propertyType, dealType, formattedPrice).addTo(markersGroup);
        
        // Create enhanced popup content
        const popupContent = `
            <div class="property-popup">
                <!-- Main Image -->
                <div class="popup-image-container">
                    <img src="${mainImage}" alt="${title}" class="popup-image" />
                </div>
                
                <!-- Content -->
                <div class="popup-content">
                    <!-- Title and Price -->
                    <div class="popup-title">${title}</div>
                    <div class="popup-price">${formattedPrice}</div>
                    
                    <!-- Location -->
                    <div class="popup-location">
                        <i class="fas fa-map-marker-alt"></i>
                        ${location}
                    </div>
                    
                    <!-- Property Details Grid -->
                    <div class="popup-details-grid">
                        <div class="popup-detail-item">
                            <i class="fas fa-home"></i>
                            <span>${propertyType}</span>
                        </div>
                        <div class="popup-detail-item">
                            <i class="fas fa-tag"></i>
                            <span>${dealType}</span>
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="popup-actions">
                        <button class="popup-button-icon" onclick="toggleFavorite(${propertyId})" title="{% trans 'В избранное' %}">
                            <i class="far fa-heart" id="favorite-${propertyId}"></i>
                        </button>
                        
                        <a href="https://wa.me/66123456789?text={% trans 'Здравствуйте! Меня интересует объект' %}: ${encodeURIComponent(title)}" 
                           class="popup-button popup-button-secondary" 
                           target="_blank">
                            <i class="fab fa-whatsapp"></i> WhatsApp
                        </a>
                        
                        <a href="${link}" class="popup-button popup-button-primary">
                            {% trans "Подробнее" %}
                        </a>
                    </div>
                </div>
            </div>
        `;
        
        marker.bindPopup(popupContent, {
            maxWidth: 280,
            className: 'enhanced-popup',
            autoPan: true,
            autoPanPadding: [20, 20],
            keepInView: true,
            closeButton: true
        });
        bounds.push([adjustedLat, adjustedLng]);
    });
    
    console.log(`Total markers added: ${bounds.length}`);
    
    // Fit map to bounds if we have markers
    if (bounds.length > 0) {
        const group = new L.featureGroup(markersGroup.getLayers());
        propertiesMap.fitBounds(group.getBounds().pad(0.1));
    } else {
        console.log('No markers to display - keeping default Phuket view');
    }
}

// Load saved view preference
document.addEventListener('DOMContentLoaded', function() {
    // Update results counter on page load
    updateResultsCounter();
    
    // Check if we need to return to map view after filter changes
    if (localStorage.getItem('returnToMapView') === 'true') {
        localStorage.removeItem('returnToMapView');
        setView('map');
    } else {
        const savedView = localStorage.getItem('propertyViewType') || 'grid';
        setView(savedView);
    }
});

// Mobile filters toggle
document.addEventListener('DOMContentLoaded', function() {
    const mobileFiltersToggle = document.getElementById('mobile-filters-toggle');
    const mobileFiltersArrow = document.getElementById('mobile-filters-arrow');
    const filtersSidebar = document.getElementById('filters-sidebar');
    
    if (mobileFiltersToggle) {
        mobileFiltersToggle.addEventListener('click', function() {
            const isHidden = filtersSidebar.classList.contains('hidden');
            
            if (isHidden) {
                filtersSidebar.classList.remove('hidden');
                filtersSidebar.classList.add('mobile-open');
                mobileFiltersArrow.style.transform = 'rotate(180deg)';
            } else {
                filtersSidebar.classList.add('hidden');
                filtersSidebar.classList.remove('mobile-open');
                mobileFiltersArrow.style.transform = 'rotate(0deg)';
            }
        });
    }
    
    // Dynamic location updates based on district selection
    const districtSelect = document.getElementById('district-select');
    const locationSelect = document.getElementById('location-select');
    
    if (districtSelect && locationSelect) {
        districtSelect.addEventListener('change', function() {
            const districtSlug = this.value;
            
            // Clear current location selection
            locationSelect.innerHTML = '<option value="">{% trans "Все локации" %}</option>';
            
            if (districtSlug) {
                // Fetch locations for the selected district
                fetch(`{% url 'properties:get_locations_for_district' %}?district=${districtSlug}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            data.locations.forEach(location => {
                                const option = document.createElement('option');
                                option.value = location.slug;
                                option.textContent = location.name;
                                locationSelect.appendChild(option);
                            });
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching locations:', error);
                    });
            }
            
            // Auto-submit form after updating locations
            setTimeout(() => {
                document.getElementById('filter-form').submit();
            }, 100);
        });
    }
    
    // Auto-submit form when any filter changes
    const form = document.getElementById('filter-form');
    if (form) {
        // Get all form inputs
        const inputs = form.querySelectorAll('input, select');
        
        inputs.forEach(input => {
            if (input.name === 'sort') return; // Skip sort field
            
            const eventType = input.type === 'checkbox' || input.type === 'radio' ? 'change' : 
                            input.tagName === 'SELECT' ? 'change' : 'input';
            
            // Different delays for different input types
            let delay = 300; // Default delay
            
            // Price inputs need longer delay to allow user to finish typing
            if (input.name === 'min_price' || input.name === 'max_price') {
                delay = 1200; // 1.2 seconds for price inputs
            }
            
            input.addEventListener(eventType, function() {
                // Clear any existing timeout for this specific input
                const timeoutKey = `filterTimeout_${input.name}`;
                clearTimeout(window[timeoutKey]);
                
                // Show loading indicator for price inputs
                if (input.name === 'min_price' || input.name === 'max_price') {
                    const indicator = input.nextElementSibling;
                    if (indicator && indicator.classList.contains('price-loading-indicator')) {
                        indicator.classList.remove('hidden');
                    }
                }
                
                // Set new timeout
                window[timeoutKey] = setTimeout(() => {
                    // Hide loading indicator before submit
                    if (input.name === 'min_price' || input.name === 'max_price') {
                        const indicator = input.nextElementSibling;
                        if (indicator && indicator.classList.contains('price-loading-indicator')) {
                            indicator.classList.add('hidden');
                        }
                    }
                    
                    // Check if we're in map view and need to preserve it after page reload
                    const currentView = localStorage.getItem('propertyViewType') || 'grid';
                    if (currentView === 'map') {
                        // Store that we want to return to map view after form submission
                        localStorage.setItem('returnToMapView', 'true');
                    }
                    
                    form.submit();
                }, delay);
            });
        });
    }
    
    // Fix pagination to work with filters using event delegation  
    document.addEventListener('click', function(e) {
        // Check if clicked element is a pagination link
        if (e.target.closest('.pagination-container a')) {
            e.preventDefault();
            
            const link = e.target.closest('.pagination-container a');
            
            // Check if this is an AJAX-generated pagination link (has data-page)
            if (link.hasAttribute('data-page')) {
                // Let AJAX handler from main.js handle this
                return;
            }
            
            // Handle Django-generated pagination links
            const url = new URL(link.href);
            const page = url.searchParams.get('page');
            
            // Get current form data
            const form = document.getElementById('filter-form');
            const formData = new FormData(form);
            
            // Convert FormData to URLSearchParams
            const params = new URLSearchParams();
            for (const [key, value] of formData.entries()) {
                if (typeof value === 'string') {
                    params.append(key, value);
                }
            }
            
            // Add/update page parameter
            params.set('page', page);
            
            // Navigate to new URL with all parameters
            window.location.href = '?' + params.toString();
        }
    });
    
    // Initialize favorites on page load
    const favorites = JSON.parse(localStorage.getItem('favorites') || '[]');
    favorites.forEach(propertyId => {
        const icon = document.getElementById(`favorite-${propertyId}`);
        if (icon) {
            icon.classList.remove('far');
            icon.classList.add('fas');
        }
    });
    
    // Update favorites counter on page load
    updateFavoritesCounter(favorites.length);
});

// Favorites functionality
function toggleFavorite(propertyId) {
    const icon = document.getElementById(`favorite-${propertyId}`);
    if (!icon) return;
    
    // Get current favorites from localStorage
    let favorites = JSON.parse(localStorage.getItem('favorites') || '[]');
    
    if (favorites.includes(propertyId)) {
        // Remove from favorites
        favorites = favorites.filter(id => id !== propertyId);
        icon.classList.remove('fas');
        icon.classList.add('far');
    } else {
        // Add to favorites
        favorites.push(propertyId);
        icon.classList.remove('far');
        icon.classList.add('fas');
    }
    
    // Save to localStorage
    localStorage.setItem('favorites', JSON.stringify(favorites));
    
    // Update favorites counter in header
    updateFavoritesCounter(favorites.length);
    
    // Optional: Show notification
    showNotification(favorites.includes(propertyId) ? 
        '{% trans "Добавлено в избранное" %}' : 
        '{% trans "Удалено из избранного" %}'
    );
}

// Update favorites counter in header
function updateFavoritesCounter(count) {
    const counters = document.querySelectorAll('.favorites-count');
    counters.forEach(counter => {
        counter.textContent = count;
        
        // Show/hide counter based on count
        if (count > 0) {
            counter.style.display = 'inline';
        } else {
            counter.style.display = 'none';
        }
    });
}

// Simple notification function
function showNotification(message) {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = 'fixed top-4 right-4 bg-primary text-white px-4 py-2 rounded-lg shadow-lg z-50 transition-all duration-300 transform translate-x-full';
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    // Slide in
    setTimeout(() => {
        notification.classList.remove('translate-x-full');
    }, 100);
    
    // Remove after 3 seconds
    setTimeout(() => {
        notification.classList.add('translate-x-full');
        setTimeout(() => {
            document.body.removeChild(notification);
        }, 300);
    }, 3000);
}

</script>
{% endblock %}