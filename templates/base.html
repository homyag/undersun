{% load static %}
{% load i18n %}
<!DOCTYPE html>
<html lang="{{ request.path|slice:'1:3'|default:LANGUAGE_CODE }}" class="overflow-x-hidden">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="{% static 'images/favicon/favicon-96x96.png' %}" sizes="96x96"/>
    <link rel="icon" type="image/svg+xml" href="{% static 'images/favicon/favicon.svg' %}"/>
    <link rel="shortcut icon" href="{% static 'images/favicon/favicon.ico' %}"/>
    <link rel="apple-touch-icon" sizes="180x180" href="{% static 'images/favicon/apple-touch-icon.png' %}"/>
{#    <link rel="manifest" href="{% static 'images/favicon/site.webmanifest' %}"/>#}
    <title>{% block title %}{{ page_title }}{% endblock %}</title>
    <!-- SEO Meta Tags -->
    <meta name="description" content="{% block description %}{{ page_description }}{% endblock %}">
    <meta name="keywords" content="{% block keywords %}{{ page_keywords }}{% endblock %}">

    <!-- Open Graph -->
    <meta property="og:title" content="{% block og_title %}{{ page_title }}{% endblock %}">
    <meta property="og:description" content="{% block og_description %}{{ page_description }}{% endblock %}">
    <meta property="og:image" content="{% block og_image %}{{ og_image_url|default:default_og_image_url }}{% endblock %}">
    <meta property="og:url" content="{{ request.build_absolute_uri }}">
    <meta property="og:locale"
          content="{% if LANGUAGE_CODE == 'ru' %}ru_RU{% elif LANGUAGE_CODE == 'en' %}en_US{% elif LANGUAGE_CODE == 'th' %}th_TH{% endif %}">
    {% if LANGUAGE_CODE == 'ru' %}
        <meta property="og:locale:alternate" content="en_US">
        <meta property="og:locale:alternate" content="th_TH">
    {% elif LANGUAGE_CODE == 'en' %}
        <meta property="og:locale:alternate" content="ru_RU">
        <meta property="og:locale:alternate" content="th_TH">
    {% elif LANGUAGE_CODE == 'th' %}
        <meta property="og:locale:alternate" content="ru_RU">
        <meta property="og:locale:alternate" content="en_US">
    {% endif %}

    <!-- Canonical URL -->
    <link rel="canonical" href="{{ canonical_url|default:request.build_absolute_uri }}">

    <!-- Hreflang Tags -->
    {% load i18n %}
    {% if hreflang_items %}
        {% for code, url in hreflang_items %}
            <link rel="alternate" hreflang="{{ code }}" href="{{ url }}">
        {% endfor %}
        {% if hreflang_x_default %}
            <link rel="alternate" hreflang="x-default" href="{{ hreflang_x_default }}">
        {% endif %}
    {% endif %}

    <!-- Font Awesome -->
{#    <link rel="stylesheet" href="{% static 'vendor/fontawesome/css/all.min.css' %}">#}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <!-- International Phone Input CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/intl-tel-input@18.2.1/build/css/intlTelInput.css">
    <link rel="stylesheet" href="{% static 'css/phone-input.css' %}">
    <!-- Tailwind CSS -->
    {% if tailwind_use_cdn %}
        <script src="https://cdn.tailwindcss.com"></script>
        <script>
            tailwind.config = {
                theme: {
                    extend: {
                        colors: {
                            primary: '#474B57',
                            secondary: '#f8f9fa',
                            accent: '#F1B400',
                            tertiary: '#616677',
                        },
                        fontFamily: {
                            sans: ['Gilroy', 'system-ui', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'Helvetica Neue', 'Arial', 'sans-serif'],
                            gilroy: ['Gilroy', 'sans-serif']
                        }
                    }
                }
            }
        </script>
    {% else %}
        <link rel="stylesheet" href="{% static 'css/dist/styles.css' %}">
    {% endif %}

    <!-- Custom CSS -->
    <link rel="stylesheet" href="{% static 'css/fonts.css' %}">
    <link rel="stylesheet" href="{% static 'css/main.css' %}">

    <!-- Responsive Navigation CSS -->
    <style>
        @media (min-width: 768px) and (max-width: 860px) {
            /* Уменьшаем размер шрифта навигации для экранов 768px-860px */
            .nav-menu-item {
                font-size: 0.875rem !important; /* text-sm */
            }

            /* Уменьшаем отступы между пунктами меню */
            .nav-menu-container {
                gap: 0.5rem !important; /* space-x-2 */
            }

            /* Уменьшаем размер шрифта для селектора языка и валюты */
            .nav-controls {
                font-size: 0.875rem !important;
            }
        }

        /* Property Tabs Styles */
        .property-tab {
            color: #6b7280;
            background-color: transparent;
        }

        .property-tab:hover {
            color: #374151;
            background-color: #f3f4f6;
        }

        .property-tab.active {
            color: #1f2937;
            background-color: #F1B400;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        }
    </style>
    {% block extra_css %}

    {% endblock %}
    <!-- CSRF Token for AJAX -->
    <meta name="csrf-token" content="{{ csrf_token }}">

    <!-- Structured Data -->
    {% block structured_data %}
        {{ block.super }}
        {% if search_schema_json %}
            <script type="application/ld+json">{{ search_schema_json|safe }}</script>
        {% endif %}
    {% endblock %}

    <!-- Extra Meta Tags -->
    {% block extra_meta %}

    {% endblock %}
</head>
<body class="overflow-x-hidden">
<!-- Yandex.Metrika counter -->
<script type="text/javascript">
    (function(m,e,t,r,i,k,a){
        m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
        m[i].l=1*new Date();
        for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
        k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)
    })(window, document,'script','https://mc.yandex.ru/metrika/tag.js', 'ym');

    ym(90630603, 'init', {webvisor:true, clickmap:true, accurateTrackBounce:true, trackLinks:true});
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/90630603" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
<!-- /Yandex.Metrika counter -->
{% include 'includes/layout/header.html' with lang=LANGUAGE_CODE|default:'ru' %}

<!-- CSRF Token for AJAX -->
<input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">

<!-- Main Content -->
<main class="pt-14 md:pt-24 pb-16 md:pb-0">
    {% if messages %}
        <div class="max-w-7xl mx-auto px-4">
            {% for message in messages %}
                <div class="mt-4 p-4 rounded-md {% if message.tags == 'success' %}bg-green-100 border border-green-400 text-green-700{% elif message.tags == 'error' %}bg-red-100 border border-red-400 text-red-700{% elif message.tags == 'warning' %}bg-yellow-100 border border-yellow-400 text-yellow-700{% else %}bg-blue-100 border border-blue-400 text-blue-700{% endif %}">
                    <div class="flex justify-between items-center">
                        <span>{{ message }}</span>
                        <button type="button" class="ml-4 text-gray-500 hover:text-gray-700"
                                onclick="this.parentElement.parentElement.remove()">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                      d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            {% endfor %}
        </div>
    {% endif %}

    {% block content %}{% endblock %}
</main>

{% include 'includes/layout/footer.html' %}
<!-- WhatsApp Button -->
<a href="https://wa.me/66633033133" class="whatsapp-btn" target="_blank"
   style="position: fixed; right: 15px; bottom: 85px; z-index: 1000; width: 50px; height: 50px; background: #25d366; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 20px; text-decoration: none; box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);">
    <i class="fab fa-whatsapp"></i>
</a>

<!-- CSS Override for Mobile WhatsApp Button -->
<style>
    @media (min-width: 768px) {
        .whatsapp-btn {
            bottom: 20px !important;
            width: 60px !important;
            height: 60px !important;
            font-size: 24px !important;
            right: 20px !important;
        }
    }

    @media (max-width: 767px) {
        .whatsapp-btn {
            bottom: 85px !important;
            width: 50px !important;
            height: 50px !important;
            font-size: 20px !important;
            right: 15px !important;
        }
    }
</style>

{% include 'includes/layout/global_scripts.html' %}
{% include "includes/cookie_consent.html" %}

<script src="{% static 'js/cookie-consent.js' %}"></script>

{% if recaptcha_site_key %}
<script src="https://www.google.com/recaptcha/api.js?render={{ recaptcha_site_key }}&hl={{ LANGUAGE_CODE|default:'en' }}" async defer></script>
<script>
  (function() {
    const siteKey = '{{ recaptcha_site_key|escapejs }}';
    if (!siteKey) {
      return;
    }

    function setupRecaptchaForms() {
      const forms = document.querySelectorAll('form[data-recaptcha-action]');
      if (!forms.length) {
        return;
      }

      if (typeof window.grecaptcha === 'undefined') {
        setTimeout(setupRecaptchaForms, 500);
        return;
      }

      forms.forEach(form => {
        if (form.dataset.recaptchaBound === 'true') {
          return;
        }
        form.dataset.recaptchaBound = 'true';

        let tokenInput = form.querySelector('input[name="g-recaptcha-response"]');
        if (!tokenInput) {
          tokenInput = document.createElement('input');
          tokenInput.type = 'hidden';
          tokenInput.name = 'g-recaptcha-response';
          form.appendChild(tokenInput);
        }

        let actionInput = form.querySelector('input[name="recaptcha_action"]');
        if (!actionInput) {
          actionInput = document.createElement('input');
          actionInput.type = 'hidden';
          actionInput.name = 'recaptcha_action';
          form.appendChild(actionInput);
        }

        const actionName = form.dataset.recaptchaAction || 'submit';
        actionInput.value = actionName;
        form.addEventListener('submit', function handleRecaptcha(event) {
          if (!window.grecaptcha || !siteKey) {
            return;
          }

          if (form.dataset.recaptchaVerified === 'true') {
            form.dataset.recaptchaVerified = '';
            return;
          }

          event.preventDefault();
          if (typeof event.stopImmediatePropagation === 'function') {
            event.stopImmediatePropagation();
          }
          if (typeof event.stopPropagation === 'function') {
            event.stopPropagation();
          }

          grecaptcha.ready(function() {
            grecaptcha.execute(siteKey, { action: actionName }).then(function(token) {
              tokenInput.value = token;
              form.dataset.recaptchaVerified = 'true';
              form.dispatchEvent(new Event('submit', { bubbles: true, cancelable: true }));
            }).catch(function() {
              form.dataset.recaptchaVerified = '';
              tokenInput.value = '';
              const errorMessage = form.dataset.recaptchaError || 'Не удалось подтвердить reCAPTCHA. Попробуйте ещё раз.';
              if (window.showErrorPopup) {
                window.showErrorPopup(errorMessage);
              } else {
                alert(errorMessage);
              }
            });
          });
        }, true);
      });
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', setupRecaptchaForms);
    } else {
      setupRecaptchaForms();
    }
  })();
</script>
{% endif %}

<!-- Success Popup Modal -->
<div id="successPopup" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50"
     style="display: none;">
    <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4 transform transition-all">
        <div class="p-6">
            <div class="flex items-center justify-center w-16 h-16 mx-auto mb-4 bg-green-100 rounded-full">
                <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
            </div>
            <h3 class="text-xl font-bold text-center text-gray-900 mb-2">{% trans "Спасибо!" %}</h3>
            <p id="successPopupMessage" class="text-center text-gray-600 mb-6"></p>
            <button id="successPopupClose"
                    class="w-full bg-primary hover:bg-primary-dark text-white font-medium py-3 px-6 rounded-lg transition-colors">
                {% trans "Закрыть" %}
            </button>
        </div>
    </div>
</div>

<!-- Error Popup Modal -->
<div id="errorPopup" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50"
     style="display: none;">
    <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4 transform transition-all">
        <div class="p-6">
            <div class="flex items-center justify-center w-16 h-16 mx-auto mb-4 bg-red-100 rounded-full">
                <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </div>
            <h3 class="text-xl font-bold text-center text-gray-900 mb-2">{% trans "Ошибка" %}</h3>
            <p id="errorPopupMessage" class="text-center text-gray-600 mb-6"></p>
            <button id="errorPopupClose"
                    class="w-full bg-red-600 hover:bg-red-700 text-white font-medium py-3 px-6 rounded-lg transition-colors">
                {% trans "Закрыть" %}
            </button>
        </div>
    </div>
</div>

<!-- Custom JS - Forms Handler (должен быть до main.js) -->
<script src="{% static 'js/forms.js' %}"></script>

<!-- Custom JS - Main Script -->
<script src="{% static 'js/main.js' %}"></script>

<!-- Favorites translations for JS -->
<script>
    window.FAVORITES_MESSAGES = {
        added: '{% trans "Добавлено в избранное" %}',
        removed: '{% trans "Удалено из избранного" %}'
    };
</script>

<!-- Extra JS Block for page-specific scripts -->
{% block extra_js %}
{% endblock %}
</body>
</html>
