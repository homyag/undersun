{% extends 'base.html' %}
{% load static %}
{% load i18n %}
{% load l10n %}

{% block title %}{% trans "Карта недвижимости" %} - Undersun Estate{% endblock %}

{% block extra_css %}
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
<style>
    .leaflet-container {
        height: calc(100vh - 120px);
        width: 100%;
    }
    
    /* Enhanced Popup Styles */
    .leaflet-popup-content-wrapper {
        border-radius: 12px !important;
        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.15) !important;
        border: none !important;
        background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%) !important;
        overflow: hidden !important;
        padding: 0 !important;
    }
    
    .leaflet-popup-tip {
        background: white !important;
        box-shadow: 0 3px 14px rgba(0, 0, 0, 0.1) !important;
    }
    
    .property-popup {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        width: 300px;
        background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.15);
        border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    /* Image Carousel */
    .popup-image-container {
        position: relative;
        height: 180px;
        overflow: hidden;
        background: linear-gradient(45deg, #f0f0f0, #e0e0e0);
    }
    
    .popup-image {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.3s ease;
    }
    
    .popup-image:hover {
        transform: scale(1.05);
    }
    
    .image-carousel-nav {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        background: rgba(255, 255, 255, 0.9);
        border: none;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 14px;
        color: #474B57;
        transition: all 0.2s ease;
        backdrop-filter: blur(10px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    .image-carousel-nav:hover {
        background: rgba(255, 255, 255, 1);
        transform: translateY(-50%) scale(1.1);
        color: #F1B400;
    }
    
    .image-carousel-nav.prev {
        left: 8px;
    }
    
    .image-carousel-nav.next {
        right: 8px;
    }
    
    .image-indicators {
        position: absolute;
        bottom: 12px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 6px;
    }
    
    .image-indicator {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.5);
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .image-indicator.active {
        background: #F1B400;
        box-shadow: 0 0 0 2px rgba(241, 180, 0, 0.3);
    }
    
    /* Content Area */
    .popup-content {
        padding: 20px;
        background: white;
    }
    
    .popup-title {
        font-weight: 700;
        font-size: 16px;
        color: #474B57;
        margin-bottom: 8px;
        line-height: 1.4;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
    
    .popup-price {
        color: #F1B400;
        font-weight: 800;
        font-size: 18px;
        margin-bottom: 12px;
        text-shadow: 0 1px 2px rgba(241, 180, 0, 0.1);
    }
    
    .popup-location {
        display: flex;
        align-items: center;
        color: #616677;
        font-size: 13px;
        margin-bottom: 12px;
    }
    
    .popup-location i {
        color: #F1B400;
        margin-right: 6px;
        font-size: 12px;
    }
    
    /* Property Details Grid */
    .popup-details-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
        margin-bottom: 16px;
    }
    
    .popup-detail-item {
        display: flex;
        align-items: center;
        font-size: 12px;
        color: #616677;
        background: rgba(71, 75, 87, 0.05);
        padding: 6px 8px;
        border-radius: 6px;
        border: 1px solid rgba(71, 75, 87, 0.1);
    }
    
    .popup-detail-item i {
        color: #F1B400;
        margin-right: 6px;
        font-size: 11px;
        min-width: 12px;
    }
    
    /* Agent Info */
    .popup-agent {
        background: linear-gradient(135deg, #474B57 0%, #616677 100%);
        color: white;
        padding: 12px 16px;
        margin: -20px -20px 16px -20px;
        border-bottom: 3px solid #F1B400;
    }
    
    .popup-agent-name {
        font-weight: 600;
        font-size: 13px;
        margin-bottom: 2px;
    }
    
    .popup-agent-title {
        font-size: 11px;
        opacity: 0.8;
    }
    
    /* Action Buttons */
    .popup-actions {
        display: flex;
        gap: 8px;
    }
    
    .popup-button {
        flex: 1;
        padding: 10px 12px;
        border-radius: 8px;
        text-decoration: none;
        font-size: 12px;
        font-weight: 600;
        text-align: center;
        transition: all 0.3s ease;
        border: none;
        cursor: pointer;
        position: relative;
        overflow: hidden;
    }
    
    .popup-button::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        transition: left 0.5s;
    }
    
    .popup-button:hover::before {
        left: 100%;
    }
    
    .popup-button-primary {
        background: linear-gradient(135deg, #474B57 0%, #616677 100%);
        color: white;
        box-shadow: 0 4px 15px rgba(71, 75, 87, 0.3);
    }
    
    .popup-button-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(71, 75, 87, 0.4);
        color: white;
    }
    
    .popup-button-secondary {
        background: linear-gradient(135deg, #F1B400 0%, #e6a300 100%);
        color: white;
        box-shadow: 0 4px 15px rgba(241, 180, 0, 0.3);
    }
    
    .popup-button-secondary:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(241, 180, 0, 0.4);
        color: white;
    }
    
    .popup-button-icon {
        background: rgba(241, 180, 0, 0.1);
        color: #F1B400;
        border: 2px solid rgba(241, 180, 0, 0.2);
        width: 36px;
        height: 36px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
    }
    
    .popup-button-icon:hover {
        background: #F1B400;
        color: white;
        transform: translateY(-2px) scale(1.1);
        box-shadow: 0 8px 25px rgba(241, 180, 0, 0.4);
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
        .property-popup {
            width: 280px;
        }
        
        .popup-content {
            padding: 16px;
        }
        
        .popup-details-grid {
            grid-template-columns: 1fr;
        }
    }
    
    /* Custom Marker Styles */
    .property-marker-wrapper {
        background: none !important;
        border: none !important;
    }
    
    .property-marker-container {
        position: relative;
        display: flex;
        flex-direction: column;
        align-items: center;
        transition: all 0.2s ease;
    }
    
    .property-marker-container:hover {
        transform: scale(1.05);
    }
    
    .custom-marker {
        position: relative;
        transition: all 0.2s ease;
        filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
    }
    
    .custom-marker:hover {
        transform: scale(1.1);
        filter: drop-shadow(0 4px 8px rgba(0,0,0,0.3));
    }
    
    .custom-marker svg {
        display: block;
    }
    
    /* Price Indicator Styles (like Booking.com) */
    .price-indicator {
        position: relative;
        background: #10b981;
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 600;
        white-space: nowrap;
        margin-bottom: 2px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        border: 2px solid white;
        transition: all 0.2s ease;
    }
    
    .price-indicator:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    
    .price-text {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        font-size: 11px;
        font-weight: 700;
        letter-spacing: 0.5px;
    }
    
    .price-arrow {
        position: absolute;
        bottom: -6px;
        left: 50%;
        transform: translateX(-50%);
        width: 0;
        height: 0;
        border-left: 6px solid transparent;
        border-right: 6px solid transparent;
        border-top: 6px solid inherit;
    }
    
    .price-arrow::before {
        content: '';
        position: absolute;
        bottom: 2px;
        left: -4px;
        width: 0;
        height: 0;
        border-left: 4px solid transparent;
        border-right: 4px solid transparent;
        border-top: 4px solid white;
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
        .price-indicator {
            font-size: 10px;
            padding: 3px 6px;
        }
        
        .price-text {
            font-size: 9px;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Map Header -->
<section class="bg-primary text-white py-8">
    <div class="max-w-7xl mx-auto px-4">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center">
            <div>
                <h1 class="text-3xl font-bold mb-2">{% trans "Карта недвижимости Пхукета" %}</h1>
                <p class="text-blue-100">{% trans "Найдите идеальное расположение для вашей недвижимости" %}</p>
            </div>
            
            <!-- Map Filters -->
            <div class="mt-4 md:mt-0">
                <div class="flex flex-wrap gap-2">
                    <button onclick="filterProperties('all')" class="filter-btn active bg-white text-primary px-4 py-2 rounded-lg text-sm font-medium shadow-md hover:shadow-lg transition-all duration-300" data-type="all">
                        {% trans "Все" %}
                    </button>
                    <button onclick="filterProperties('sale')" class="filter-btn bg-primary hover:bg-tertiary text-white px-4 py-2 rounded-lg text-sm font-medium shadow-md hover:shadow-lg transition-all duration-300" data-type="sale">
                        {% trans "Продажа" %}
                    </button>
                    <button onclick="filterProperties('rent')" class="filter-btn bg-primary hover:bg-tertiary text-white px-4 py-2 rounded-lg text-sm font-medium shadow-md hover:shadow-lg transition-all duration-300" data-type="rent">
                        {% trans "Аренда" %}
                    </button>
                    <button onclick="filterProperties('villa')" class="filter-btn bg-primary hover:bg-tertiary text-white px-4 py-2 rounded-lg text-sm font-medium shadow-md hover:shadow-lg transition-all duration-300" data-type="villa">
                        {% trans "Виллы" %}
                    </button>
                    <button onclick="filterProperties('apartment')" class="filter-btn bg-primary hover:bg-tertiary text-white px-4 py-2 rounded-lg text-sm font-medium shadow-md hover:shadow-lg transition-all duration-300" data-type="apartment">
                        {% trans "Апартаменты" %}
                    </button>
                    <button onclick="filterProperties('investment')" class="filter-btn bg-primary hover:bg-tertiary text-white px-4 py-2 rounded-lg text-sm font-medium shadow-md hover:shadow-lg transition-all duration-300" data-type="investment">
                        {% trans "Инвестиции" %}
                    </button>
                    <button onclick="filterProperties('townhouse')" class="filter-btn bg-primary hover:bg-tertiary text-white px-4 py-2 rounded-lg text-sm font-medium shadow-md hover:shadow-lg transition-all duration-300" data-type="townhouse">
                        {% trans "Таунхаусы" %}
                    </button>
                    <button onclick="filterProperties('land')" class="filter-btn bg-primary hover:bg-tertiary text-white px-4 py-2 rounded-lg text-sm font-medium shadow-md hover:shadow-lg transition-all duration-300" data-type="land">
                        {% trans "Земля" %}
                    </button>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Map Section -->
<section class="relative">
    <div id="property-map" class="w-full"></div>
    
    <!-- Map Legend -->
    <div class="absolute top-4 right-4 bg-white p-4 rounded-lg shadow-lg z-1000">
        <h3 class="font-semibold text-gray-900 mb-3">{% trans "Легенда" %}</h3>
        <div class="space-y-2 text-sm">
            <div class="flex items-center">
                <div class="w-4 h-4 bg-green-500 rounded-full mr-2"></div>
                <span>{% trans "Продажа" %}</span>
            </div>
            <div class="flex items-center">
                <div class="w-4 h-4 bg-blue-500 rounded-full mr-2"></div>
                <span>{% trans "Аренда" %}</span>
            </div>
            <div class="flex items-center">
                <div class="w-4 h-4 bg-purple-500 rounded-full mr-2"></div>
                <span>{% trans "Продажа/Аренда" %}</span>
            </div>
        </div>
        
        <div class="mt-4 pt-3 border-t border-gray-200">
            <div class="text-xs text-gray-600">
                <div>{% trans "Всего объектов" %}: <span id="total-count">{{ properties.count }}</span></div>
                <div>{% trans "Показано" %}: <span id="visible-count">{{ properties.count }}</span></div>
            </div>
        </div>
    </div>
    
    <!-- Loading Indicator -->
    <div id="map-loading" class="absolute inset-0 bg-white bg-opacity-75 flex items-center justify-center z-1000">
        <div class="text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto mb-4"></div>
            <p class="text-gray-600">{% trans "Загружаем карту..." %}</p>
        </div>
    </div>
</section>

<!-- Quick Stats -->
<section class="bg-gray-50 py-8">
    <div class="max-w-7xl mx-auto px-4">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
            <div class="text-center">
                <div class="text-2xl font-bold text-primary mb-1">{{ total_properties }}</div>
                <div class="text-gray-600 text-sm">{% trans "Всего объектов" %}</div>
            </div>
            <div class="text-center">
                <div class="text-2xl font-bold text-green-600 mb-1">{{ sale_properties }}</div>
                <div class="text-gray-600 text-sm">{% trans "На продажу" %}</div>
            </div>
            <div class="text-center">
                <div class="text-2xl font-bold text-blue-600 mb-1">{{ rent_properties }}</div>
                <div class="text-gray-600 text-sm">{% trans "В аренду" %}</div>
            </div>
            <div class="text-center">
                <div class="text-2xl font-bold text-purple-600 mb-1">{{ districts_count }}</div>
                <div class="text-gray-600 text-sm">{% trans "Районов" %}</div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<!-- Leaflet JavaScript -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
<script>
// Initialize the map
var map = L.map('property-map').setView([7.8804, 98.3923], 11);

// Add tile layer
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
}).addTo(map);

// Properties data
var properties = [
    // This will be populated from Django context
    {% for property in properties %}
    {
        id: {{ property.id }},
        title: "{{ property.title|escapejs }}",
        lat: {{ property.latitude|default:"0"|unlocalize }},
        lng: {{ property.longitude|default:"0"|unlocalize }},
        price: "{{ property.price_display|escapejs }}",
        deal_type: "{{ property.deal_type|escapejs }}",
        property_type: "{{ property.property_type.name|escapejs }}",
        district: "{{ property.district.name|escapejs }}",
        bedrooms: {{ property.bedrooms|default:"0" }},
        bathrooms: {{ property.bathrooms|default:"0" }},
        area: {{ property.area_total|default:"0"|unlocalize }},
        price_sale_usd: {{ property.price_sale_usd|default:"0"|unlocalize }},
        price_sale_thb: {{ property.price_sale_thb|default:"0"|unlocalize }},
        price_sale_rub: {{ property.price_sale_rub|default:"0"|unlocalize }},
        price_rent_usd: {{ property.price_rent_monthly_usd|default:"0"|unlocalize }},
        price_rent_thb: {{ property.price_rent_monthly_thb|default:"0"|unlocalize }},
        price_rent_rub: {{ property.price_rent_monthly_rub|default:"0"|unlocalize }},
        image: "{% if property.main_image and property.main_image.image %}{{ property.main_image.medium.url }}{% else %}{% static 'images/no-image.jpg' %}{% endif %}",
        images: [
            {% if property.main_image and property.main_image.image %}"{{ property.main_image.medium.url }}"{% else %}"{% static 'images/no-image.jpg' %}"{% endif %}
            {% for image in property.images.all|slice:":2" %},
            "{{ image.medium.url }}"
            {% endfor %}
        ],
        floors: {{ property.floors_total|default:"0" }},
        current_floor: {{ property.floor|default:"0" }},
        agent_name: "{% if property.agent %}{{ property.agent.name|escapejs }}{% else %}Undersun Estate{% endif %}",
        agent_phone: "{% if property.agent %}{{ property.agent.phone|escapejs }}{% else %}+66 12 345 6789{% endif %}",
        location_name: "{% if property.location %}{{ property.location.name|escapejs }}{% else %}{{ property.district.name|escapejs }}{% endif %}",
        url: "{{ property.get_absolute_url }}"
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
];

// Create marker cluster group
var markers = L.markerClusterGroup();
var allMarkers = [];

// Function to get marker color based on deal type
function getMarkerColor(dealType) {
    switch(dealType) {
        case 'sale': return '#10b981'; // green
        case 'rent': return '#3b82f6'; // blue
        case 'both': return '#8b5cf6'; // purple
        default: return '#6b7280'; // gray
    }
}

// Function to get property type icon SVG content
function getPropertyIconSVG(propertyType) {
    const iconSVGs = {
        'villa': `
            <g transform="translate(6, 6)">
                <path d="M10 4L2 10h2v8h12v-8h2L10 4z" fill="white"/>
                <rect x="4" y="10" width="12" height="8" fill="white"/>
                <rect x="8.5" y="14" width="3" height="4" fill="currentColor"/>
                <rect x="5.5" y="12" width="2" height="2" fill="currentColor"/>
                <rect x="12.5" y="12" width="2" height="2" fill="currentColor"/>
                <rect x="13" y="6" width="1.5" height="4" fill="white"/>
            </g>
        `,
        'apartment': `
            <g transform="translate(6, 4)">
                <rect x="2" y="4" width="16" height="16" fill="white"/>
                <polygon points="1,4 10,1 19,4" fill="white"/>
                <rect x="4" y="7" width="2" height="2" fill="currentColor"/>
                <rect x="7" y="7" width="2" height="2" fill="currentColor"/>
                <rect x="11" y="7" width="2" height="2" fill="currentColor"/>
                <rect x="14" y="7" width="2" height="2" fill="currentColor"/>
                <rect x="4" y="11" width="2" height="2" fill="currentColor"/>
                <rect x="7" y="11" width="2" height="2" fill="currentColor"/>
                <rect x="11" y="11" width="2" height="2" fill="currentColor"/>
                <rect x="14" y="11" width="2" height="2" fill="currentColor"/>
                <rect x="4" y="15" width="2" height="2" fill="currentColor"/>
                <rect x="14" y="15" width="2" height="2" fill="currentColor"/>
                <rect x="8" y="15" width="4" height="5" fill="currentColor"/>
            </g>
        `,
        'condominium': `
            <g transform="translate(6, 4)">
                <rect x="2" y="4" width="16" height="16" fill="white"/>
                <polygon points="1,4 10,1 19,4" fill="white"/>
                <rect x="4" y="7" width="2" height="2" fill="currentColor"/>
                <rect x="7" y="7" width="2" height="2" fill="currentColor"/>
                <rect x="11" y="7" width="2" height="2" fill="currentColor"/>
                <rect x="14" y="7" width="2" height="2" fill="currentColor"/>
                <rect x="4" y="11" width="2" height="2" fill="currentColor"/>
                <rect x="7" y="11" width="2" height="2" fill="currentColor"/>
                <rect x="11" y="11" width="2" height="2" fill="currentColor"/>
                <rect x="14" y="11" width="2" height="2" fill="currentColor"/>
                <rect x="4" y="15" width="2" height="2" fill="currentColor"/>
                <rect x="14" y="15" width="2" height="2" fill="currentColor"/>
                <rect x="8" y="15" width="4" height="5" fill="currentColor"/>
            </g>
        `,
        'townhouse': `
            <g transform="translate(4, 5)">
                <rect x="0" y="8" width="7" height="10" fill="white"/>
                <polygon points="0,8 3.5,4 7,8" fill="white"/>
                <rect x="6" y="6" width="7" height="12" fill="white"/>
                <polygon points="6,6 9.5,2 13,6" fill="white"/>
                <rect x="12" y="9" width="7" height="9" fill="white"/>
                <polygon points="12,9 15.5,5 19,9" fill="white"/>
                <rect x="2" y="14" width="2" height="4" fill="currentColor"/>
                <rect x="8" y="14" width="2" height="4" fill="currentColor"/>
                <rect x="14" y="14" width="2" height="4" fill="currentColor"/>
                <rect x="1" y="11" width="1.5" height="1.5" fill="currentColor"/>
                <rect x="4.5" y="11" width="1.5" height="1.5" fill="currentColor"/>
                <rect x="7" y="9" width="1.5" height="1.5" fill="currentColor"/>
                <rect x="10.5" y="9" width="1.5" height="1.5" fill="currentColor"/>
                <rect x="13" y="12" width="1.5" height="1.5" fill="currentColor"/>
                <rect x="16.5" y="12" width="1.5" height="1.5" fill="currentColor"/>
            </g>
        `,
        'land': `
            <g transform="translate(5, 6)">
                <rect x="1" y="2" width="18" height="14" fill="none" stroke="white" stroke-width="1.5" stroke-dasharray="2,1"/>
                <circle cx="6" cy="8" r="3" fill="white"/>
                <rect x="5.5" y="11" width="1" height="3" fill="white"/>
                <circle cx="14" cy="6" r="2.5" fill="white"/>
                <rect x="13.5" y="8.5" width="1" height="2.5" fill="white"/>
                <circle cx="4" cy="13" r="1.5" fill="white"/>
                <circle cx="16" cy="12" r="1.5" fill="white"/>
                <circle cx="2" cy="3" r="1" fill="white"/>
                <circle cx="18" cy="3" r="1" fill="white"/>
                <circle cx="2" cy="15" r="1" fill="white"/>
                <circle cx="18" cy="15" r="1" fill="white"/>
            </g>
        `,
        'business': `
            <g transform="translate(6, 5)">
                <rect x="2" y="6" width="16" height="12" fill="white"/>
                <polygon points="1,6 10,3 19,6" fill="white"/>
                <rect x="3" y="14" width="6" height="4" fill="currentColor"/>
                <rect x="11" y="14" width="6" height="4" fill="currentColor"/>
                <rect x="4" y="9" width="2" height="2" fill="currentColor"/>
                <rect x="7" y="9" width="2" height="2" fill="currentColor"/>
                <rect x="11" y="9" width="2" height="2" fill="currentColor"/>
                <rect x="14" y="9" width="2" height="2" fill="currentColor"/>
                <rect x="3" y="12" width="14" height="1" fill="white"/>
                <rect x="9" y="15" width="2" height="3" fill="white"/>
            </g>
        `
    };
    
    return iconSVGs[propertyType.toLowerCase()] || `
        <g transform="translate(7, 6)">
            <rect x="2" y="10" width="14" height="10" fill="white"/>
            <polygon points="1,10 9,4 17,10" fill="white"/>
            <rect x="7" y="15" width="4" height="5" fill="currentColor"/>
            <rect x="4" y="13" width="2.5" height="2" fill="currentColor"/>
            <rect x="11.5" y="13" width="2.5" height="2" fill="currentColor"/>
        </g>
    `;
}

// Function to format price for display
function formatPriceForMarker(property) {
    // Get the best available price
    let price = null;
    let currency = 'USD';
    
    if (property.deal_type === 'sale' || property.deal_type === 'both') {
        if (property.price_sale_usd && property.price_sale_usd > 0) {
            price = property.price_sale_usd;
            currency = 'USD';
        } else if (property.price_sale_thb && property.price_sale_thb > 0) {
            price = property.price_sale_thb;
            currency = 'THB';
        } else if (property.price_sale_rub && property.price_sale_rub > 0) {
            price = property.price_sale_rub;
            currency = 'RUB';
        }
    } else if (property.deal_type === 'rent') {
        if (property.price_rent_usd && property.price_rent_usd > 0) {
            price = property.price_rent_usd;
            currency = 'USD';
        } else if (property.price_rent_thb && property.price_rent_thb > 0) {
            price = property.price_rent_thb;
            currency = 'THB';
        } else if (property.price_rent_rub && property.price_rent_rub > 0) {
            price = property.price_rent_rub;
            currency = 'RUB';
        }
    }
    
    if (!price || price <= 0) return null;
    
    // Format price for display
    const currencySymbols = { USD: '$', THB: '฿', RUB: '₽' };
    const symbol = currencySymbols[currency] || '$';
    
    // Format large numbers
    if (price >= 1000000) {
        return `${symbol}${(price / 1000000).toFixed(1)}M`;
    } else if (price >= 1000) {
        return `${symbol}${Math.round(price / 1000)}K`;
    } else {
        return `${symbol}${Math.round(price)}`;
    }
}

// Function to create custom marker
function createMarker(property) {
    const iconUrl = `/static/images/markers/${getPropertyIcon(property.property_type)}`;
    const markerColor = getMarkerColor(property.deal_type);
    const priceDisplay = formatPriceForMarker(property);
    
    // Create marker with price indicator
    const customIcon = L.divIcon({
        html: `
            <div class="property-marker-container">
                <!-- Price indicator (like Booking.com) -->
                ${priceDisplay ? `
                <div class="price-indicator" style="background: ${markerColor};">
                    <span class="price-text">${priceDisplay}</span>
                    <div class="price-arrow"></div>
                </div>
                ` : ''}
                
                <!-- Property icon marker -->
                <div class="custom-marker" style="color: ${markerColor};">
                    <svg width="32" height="40" viewBox="0 0 32 40" xmlns="http://www.w3.org/2000/svg">
                        <path d="M16 0C7.16 0 0 7.16 0 16c0 12 16 24 16 24s16-12 16-24C32 7.16 24.84 0 16 0z" fill="${markerColor}"/>
                        ${getPropertyIconSVG(property.property_type)}
                    </svg>
                </div>
            </div>
        `,
        className: 'property-marker-wrapper',
        iconSize: [140, 60], // Увеличиваем размер для размещения цены
        iconAnchor: [70, 60], // Центрируем по горизонтали, привязка к низу
        popupAnchor: [0, -60]
    });
    
    var marker = L.marker([property.lat, property.lng], {
        icon: customIcon
    });
    
    // Create enhanced popup content
    const hasMultipleImages = property.images && property.images.length > 1;
    const currentImageIndex = 0;
    
    var popupContent = `
        <div class="property-popup">
            <!-- Image Carousel -->
            <div class="popup-image-container" data-property-id="${property.id}">
                <img src="${property.images ? property.images[0] : property.image}" 
                     alt="${property.title}" 
                     class="popup-image" 
                     data-image-index="0" />
                
                ${hasMultipleImages ? `
                    <button class="image-carousel-nav prev" onclick="changePopupImage(${property.id}, -1)">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <button class="image-carousel-nav next" onclick="changePopupImage(${property.id}, 1)">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                    
                    <div class="image-indicators">
                        ${property.images.map((img, index) => `
                            <div class="image-indicator ${index === 0 ? 'active' : ''}" 
                                 onclick="setPopupImage(${property.id}, ${index})" 
                                 data-index="${index}"></div>
                        `).join('')}
                    </div>
                ` : ''}
            </div>
            
            <!-- Content -->
            <div class="popup-content">
                <!-- Agent Info -->
                <div class="popup-agent">
                    <div class="popup-agent-name">${property.agent_name}</div>
                    <div class="popup-agent-title">{% trans "Агент по недвижимости" %}</div>
                </div>
                
                <!-- Title and Price -->
                <div class="popup-title">${property.title}</div>
                <div class="popup-price">${property.price}</div>
                
                <!-- Location -->
                <div class="popup-location">
                    <i class="fas fa-map-marker-alt"></i>
                    ${property.location_name || property.district}
                </div>
                
                <!-- Property Details Grid -->
                <div class="popup-details-grid">
                    ${property.bedrooms > 0 ? `
                        <div class="popup-detail-item">
                            <i class="fas fa-bed"></i>
                            <span>${property.bedrooms} {% trans "спален" %}</span>
                        </div>
                    ` : ''}
                    ${property.bathrooms > 0 ? `
                        <div class="popup-detail-item">
                            <i class="fas fa-bath"></i>
                            <span>${property.bathrooms} {% trans "ванных" %}</span>
                        </div>
                    ` : ''}
                    ${property.area > 0 ? `
                        <div class="popup-detail-item">
                            <i class="fas fa-ruler-combined"></i>
                            <span>${property.area} м²</span>
                        </div>
                    ` : ''}
                    ${property.current_floor > 0 ? `
                        <div class="popup-detail-item">
                            <i class="fas fa-building"></i>
                            <span>${property.current_floor}/${property.floors} {% trans "этаж" %}</span>
                        </div>
                    ` : ''}
                </div>
                
                <!-- Action Buttons -->
                <div class="popup-actions">
                    <button class="popup-button-icon" onclick="toggleFavorite(${property.id})" title="{% trans 'В избранное' %}">
                        <i class="far fa-heart" id="favorite-${property.id}"></i>
                    </button>
                    
                    <a href="https://wa.me/${property.agent_phone.replace(/[^0-9]/g, '')}?text={% trans 'Здравствуйте! Меня интересует объект' %}: ${encodeURIComponent(property.title)}" 
                       class="popup-button popup-button-secondary" 
                       target="_blank">
                        <i class="fab fa-whatsapp"></i> WhatsApp
                    </a>
                    
                    <a href="${property.url}" class="popup-button popup-button-primary">
                        {% trans "Подробнее" %}
                    </a>
                </div>
            </div>
        </div>
    `;
    
    marker.bindPopup(popupContent, {
        maxWidth: 320,
        className: 'enhanced-popup'
    });
    marker.propertyData = property;
    
    return marker;
}

// Add all properties to map
properties.forEach(function(property) {
    if (property.lat && property.lng && property.lat !== 0 && property.lng !== 0) {
        var marker = createMarker(property);
        allMarkers.push(marker);
        markers.addLayer(marker);
    }
});

// Add markers to map
map.addLayer(markers);

// Filter functions
function filterProperties(type) {
    // Update button states
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('active', 'bg-white', 'text-primary');
        btn.classList.add('bg-primary', 'hover:bg-tertiary', 'text-white');
    });
    
    var activeBtn = document.querySelector(`[data-type="${type}"]`);
    activeBtn.classList.add('active', 'bg-white', 'text-primary');
    activeBtn.classList.remove('bg-primary', 'hover:bg-tertiary', 'text-white');
    
    // Clear existing markers
    markers.clearLayers();
    
    // Filter and add markers
    var visibleCount = 0;
    allMarkers.forEach(function(marker) {
        var property = marker.propertyData;
        var show = false;
        
        if (type === 'all') {
            show = true;
        } else if (type === 'sale' || type === 'rent') {
            show = property.deal_type === type || property.deal_type === 'both';
        } else {
            show = property.property_type === type;
        }
        
        if (show) {
            markers.addLayer(marker);
            visibleCount++;
        }
    });
    
    // Update counter
    document.getElementById('visible-count').textContent = visibleCount;
}

// Hide loading indicator when map is ready
map.whenReady(function() {
    document.getElementById('map-loading').style.display = 'none';
});

// Handle map resize
window.addEventListener('resize', function() {
    map.invalidateSize();
});

// Image carousel functionality
function changePopupImage(propertyId, direction) {
    const container = document.querySelector(`[data-property-id="${propertyId}"]`);
    if (!container) return;
    
    const img = container.querySelector('.popup-image');
    const indicators = container.querySelectorAll('.image-indicator');
    
    if (!img || indicators.length === 0) return;
    
    const currentIndex = parseInt(img.dataset.imageIndex);
    let newIndex = currentIndex + direction;
    
    // Wrap around
    if (newIndex < 0) newIndex = indicators.length - 1;
    if (newIndex >= indicators.length) newIndex = 0;
    
    setPopupImage(propertyId, newIndex);
}

function setPopupImage(propertyId, index) {
    const container = document.querySelector(`[data-property-id="${propertyId}"]`);
    if (!container) return;
    
    const img = container.querySelector('.popup-image');
    const indicators = container.querySelectorAll('.image-indicator');
    
    if (!img || !indicators[index]) return;
    
    // Find the property data
    const property = properties.find(p => p.id == propertyId);
    if (!property || !property.images) return;
    
    // Update image
    img.src = property.images[index];
    img.dataset.imageIndex = index;
    
    // Update indicators
    indicators.forEach((indicator, i) => {
        indicator.classList.toggle('active', i === index);
    });
}

// Favorites functionality
function toggleFavorite(propertyId) {
    const icon = document.getElementById(`favorite-${propertyId}`);
    if (!icon) return;
    
    // Get current favorites from localStorage
    let favorites = JSON.parse(localStorage.getItem('favorites') || '[]');
    
    if (favorites.includes(propertyId)) {
        // Remove from favorites
        favorites = favorites.filter(id => id !== propertyId);
        icon.classList.remove('fas');
        icon.classList.add('far');
    } else {
        // Add to favorites
        favorites.push(propertyId);
        icon.classList.remove('far');
        icon.classList.add('fas');
    }
    
    // Save to localStorage
    localStorage.setItem('favorites', JSON.stringify(favorites));
    
    // Optional: Show notification
    showNotification(favorites.includes(propertyId) ? 
        '{% trans "Добавлено в избранное" %}' : 
        '{% trans "Удалено из избранного" %}'
    );
}

// Initialize favorites on page load
document.addEventListener('DOMContentLoaded', function() {
    const favorites = JSON.parse(localStorage.getItem('favorites') || '[]');
    favorites.forEach(propertyId => {
        const icon = document.getElementById(`favorite-${propertyId}`);
        if (icon) {
            icon.classList.remove('far');
            icon.classList.add('fas');
        }
    });
});

// Simple notification function
function showNotification(message) {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = 'fixed top-4 right-4 bg-primary text-white px-4 py-2 rounded-lg shadow-lg z-50 transition-all duration-300 transform translate-x-full';
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    // Slide in
    setTimeout(() => {
        notification.classList.remove('translate-x-full');
    }, 100);
    
    // Remove after 3 seconds
    setTimeout(() => {
        notification.classList.add('translate-x-full');
        setTimeout(() => {
            document.body.removeChild(notification);
        }, 300);
    }, 3000);
}
</script>
{% endblock %}